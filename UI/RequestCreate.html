<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Quản Lý Tổng Hợp - Trung Tâm Ngoại Ngữ 68</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Liên kết Font Awesome để sử dụng các biểu tượng -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Thiết lập font và màu nền chung */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Màu nền nhẹ nhàng hơn */
            color: #333333; /* Màu chữ mặc định */
            display: flex;
            flex-direction: column; /* Đảm bảo nội dung chính xếp chồng dọc */
        }

        /* Khu vực nội dung chính */
        .main-content {
            flex-grow: 1; /* Cho phép mở rộng để lấp đầy không gian còn lại */
            display: flex;
            flex-direction: column;
            background-color: #ffffff; /* Nền trắng cho nội dung chính đồng bộ */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Đổ bóng nhẹ nhàng đồng bộ */
            border-radius: 0; /* Loại bỏ bo góc để lấp đầy trang */
            width: 100%; /* Đảm bảo chiếm toàn bộ chiều rộng */
            max-width: none; /* Loại bỏ giới hạn chiều rộng tối đa */
            margin: 0; /* Loại bỏ margin tự động */
            overflow-y: auto; /* Cho phép cuộn nếu nội dung form tràn */
        }

        /* Tiêu đề (Header) */
        .header {
            background-color: #2d3748;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-radius: 0; /* Loại bỏ bo góc để lấp đầy trang */
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 30px; /* Tăng khoảng cách giữa logo và tiêu đề */
            flex-grow: 1; /* Cho phép phần tử này mở rộng để lấp đầy không gian */
            justify-content: flex-start; /* Giữ nội dung căn trái */
        }

        .header-logo img {
            height: 100px;
            width: 100px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #e2e8f0;
            white-space: nowrap;
        }

        .header-date {
            font-size: 1rem;
            color: #a0aec0;
            white-space: nowrap;
            margin-right: 20px; /* Khoảng cách giữa ngày tháng và icon */
        }

        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        /* Notification specific styles - Đồng bộ với RequestCreate.html */
        .header-notification-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .header-notification-wrapper svg {
            width: 24px;
            height: 24px;
            color: #a0aec0;
            transition: color 0.2s ease-in-out;
        }

        .header-notification-wrapper svg:hover {
            color: #ffffff;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #e74c3c;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 50%;
            min-width: 18px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            display: none; /* Hidden by default, show with JS if count > 0 */
        }

        .notification-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background-color: #2d3748;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            z-index: 10;
            min-width: 280px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            flex-direction: column;
            padding: 10px 0;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }

        .notification-dropdown.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .notification-dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px 10px;
            border-bottom: 1px solid #4a5568;
            margin-bottom: 10px;
        }

        .notification-dropdown-header h3 {
            color: #e2e8f0;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .mark-all-read-btn {
            background: none;
            border: none;
            color: #a0aec0;
            font-size: 0.85rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .mark-all-read-btn:hover {
            color: #ffffff;
        }

        .notification-category-header {
            padding: 8px 15px;
            background-color: #4a5568;
            color: #e2e8f0;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #667eea;
            margin-top: 5px;
        }

        .notification-item {
            padding: 10px 15px;
            color: #e2e8f0;
            border-bottom: 1px solid #4a5568;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item:hover {
            background-color: #4a5568;
        }

        .notification-item strong {
            color: #ffffff;
        }

        .notification-item .time {
            display: block;
            font-size: 0.75rem;
            color: #a0aec0;
            margin-top: 2px;
        }

        .no-notifications {
            padding: 10px 15px;
            color: #a0aec0;
            text-align: center;
            font-style: italic;
        }

        /* Thông tin người dùng và dropdown */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            cursor: pointer;
            padding: 5px 0;
        }

        .user-info img {
            width: 36px; /* Kích thước avatar lớn hơn một chút */
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #4299e1; /* Viền xanh nổi bật */
        }

        .user-details {
            display: flex;
            flex-direction: column;
            text-align: left; /* Căn trái thông tin người dùng */
            white-space: nowrap;
            font-size: 0.95rem;
            font-weight: 500;
            color: #e2e8f0;
        }

        .user-details .user-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .user-details .user-title {
            font-size: 0.85rem;
            color: #a0aec0;
        }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 10px); /* Khoảng cách với user-info */
            right: 0;
            background-color: #2d3748;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            z-index: 10;
            min-width: 160px; /* Rộng hơn một chút */
            display: none;
            flex-direction: column;
            padding: 10px 0;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }

        .user-dropdown.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .user-dropdown button {
            background: none;
            border: none;
            color: #e2e8f0;
            padding: 10px 15px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border-radius: 0;
            font-size: 0.95rem;
        }

        .user-dropdown button:hover {
            background-color: #4a5568;
            color: #ffffff;
        }

        /* Content Sections */
        .content-section {
            display: none; /* Hidden by default */
            padding: 30px;
            flex-grow: 1;
            overflow-y: auto;
            background-color: #ffffff;
        }

        .content-section.active {
            display: flex;
            flex-direction: column;
        }

        /* Request Form Specific Styles (from RequestCreate.html) */
        .request-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 3px solid #3498db;
        }

        .request-form-section {
            background-color: #fdfdfd;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            margin-bottom: 40px;
        }

        .request-form-section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8em;
            text-align: center;
            border-bottom: 2px solid #f39c12;
            padding-bottom: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555555;
            font-size: 0.95em;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea,
        .form-group input[type="time"] {
            width: 100%;
            background-color: #fcfcfc;
            color: #333333;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 1em;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="tel"]:focus,
        .form-group input[type="date"]:focus,
        .form-group select:focus,
        .form-group textarea:focus,
        .form-group input[type="time"]:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .form-group .read-only-field {
            background-color: #e9ecef;
            color: #6c757d;
            border: 1px solid #dee2e6;
            cursor: not-allowed;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 0;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            height: 18px;
            width: 18px;
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .action-buttons button {
            background-color: #28a745;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .action-buttons button:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* Tuition Management Specific Styles (from Tusision.html) */
        .dashboard-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 3px solid #3498db;
        }

        .table-section {
            background-color: #fdfdfd;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }

        .table-section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8em;
            text-align: center;
            border-bottom: 2px solid #f39c12;
            padding-bottom: 12px;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .add-button {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .add-button:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        .add-button svg {
            width: 22px;
            height: 22px;
        }
        
        .search-bar {
            flex-grow: 1;
            max-width: 450px;
        }

        .search-bar input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            background-color: #f8f9fa;
            color: #495057;
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-bar input[type="text"]:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .table-container {
            overflow-x: auto;
            max-height: 65vh;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1800px; /* Increased min-width for new columns */
        }

        .data-table th, .data-table td {
            padding: 15px 20px;
            text-align: left;
            border: 1px solid #e9ecef;
            color: #343a40;
            white-space: nowrap;
            font-size: 0.95em;
        }

        .data-table th {
            background-color: #e9ecef;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .data-table tbody tr:hover {
            background-color: #e2f0fe;
            cursor: pointer;
        }

        .data-table .actions button {
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 5px;
            font-size: 0.9em;
        }

        .data-table .actions .edit-btn {
            background-color: #4299e1;
        }

        .data-table .actions .edit-btn:hover {
            background-color: #3182ce;
        }
        
        /* Style for invoice image link */
        .invoice-link-trigger {
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            display: inline-block; /* To allow padding/margin if needed */
        }
        .invoice-link-trigger:hover {
            color: #0056b3;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            color: #333333;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-content h3 {
            font-size: 1.8em;
            margin-bottom: 25px;
            text-align: center;
            color: #2c3e50;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .modal-content .form-group { margin-bottom: 0; }
        .modal-content .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555555;
            font-size: 0.95em;
        }

        .modal-content .form-group input,
        .modal-content .form-group select {
            width: 100%;
            background-color: #fcfcfc;
            color: #333333;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 1em;
            box-sizing: border-box;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .modal-content .form-group input:focus,
        .modal-content .form-group select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .modal-content .form-group input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
            color: #666666;
        }
        .modal-content .form-group input[disabled],
        .modal-content .form-group select[disabled] {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Radio button specific styles */
        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: normal; /* Override form-group label font-weight */
        }
        .radio-group input[type="radio"] {
            width: auto; /* Allow radio button to take its natural width */
            margin: 0; /* Remove default margin */
        }

        /* Invoice Image Preview */
        .invoice-image-preview-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            margin-top: 10px;
        }
        .invoice-image-preview {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            object-fit: contain;
            border: 1px solid #e0e0e0;
        }
        .clear-image-btn {
            background-color: #dc3545;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .clear-image-btn:hover {
            background-color: #c82333;
        }


        .modal-content .form-actions {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            grid-column: 1 / -1;
        }

        .modal-content .form-actions button {
            padding: 12px 25px;
            font-size: 1em;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        }
        .modal-content .form-actions .submit-button { background-color: #28a745; color: white; }
        .modal-content .form-actions .submit-button:hover { background-color: #218838; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .modal-content .form-actions .cancel-button { background-color: #6c757d; color: white; }
        .modal-content .form-actions .cancel-button:hover { background-color: #5a6268; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8em;
            color: #888888;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-btn:hover { color: #333333; }

        /* Loading & Message Overlays */
        .full-screen-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10003; /* Adjusted z-index to be above modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .full-screen-loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .full-screen-spinner {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #fff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .custom-message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-message-box-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .custom-message-box-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            color: #333333;
        }
        .custom-message-box-content p { font-size: 1.1rem; margin-bottom: 20px; }
        .custom-message-box-content button {
            background-color: #4299e1;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .custom-message-box-content button:hover { background-color: #3182ce; }

        /* Image Viewer Modal Styles */
        #imageViewerModal {
            z-index: 10001; /* Higher z-index than other modals */
        }
        #imageViewerModal .modal-content {
            max-width: 95%; /* Increased max-width */
            max-height: 95%; /* Increased max-height */
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #ffffff; /* Removed dark background */
        }
        #imageViewerModal img {
            max-width: 100%;
            max-height: 85vh; /* Adjusted to fit larger modal content */
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        #imageViewerModal .modal-close-btn {
            color: #888888; /* Changed back to default close button color */
            top: 15px;
            right: 15px;
            font-size: 1.8em; /* Changed back to default close button size */
            text-shadow: none; /* Removed text shadow */
        }
        #imageViewerModal .modal-close-btn:hover {
            color: #333333; /* Changed back to default close button hover color */
        }

        /* Styles for Document Selection Modal (from RequestCreate.html) */
        .document-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10004;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .document-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .document-modal-content {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .document-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .document-modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .document-modal-header .close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
        }

        .document-modal-header .close-btn:hover {
            color: #333;
        }

        .document-modal-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .document-modal-controls input[type="text"],
        .document-modal-controls select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            min-width: 180px; /* Ensure inputs don't get too small */
        }

        .document-list-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }

        .document-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .document-list-item:last-child {
            border-bottom: none;
        }

        .document-list-item:hover {
            background-color: #f9f9f9;
        }

        .document-list-item .doc-info {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .document-list-item .doc-name {
            font-weight: 600;
            color: #333;
        }

        .document-list-item .doc-type {
            font-size: 0.85em;
            color: #666;
        }

        .document-list-item .doc-id {
            font-size: 0.8em;
            color: #999;
            margin-left: 15px;
            white-space: nowrap;
        }

        .no-documents-found {
            text-align: center;
            padding: 20px;
            color: #888;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .header-date { display: none; }
            .request-title, .dashboard-title { font-size: 1.8rem; }
            .request-form-section h2, .table-section h2 { font-size: 1.5em; }
            .action-buttons { flex-direction: column; gap: 10px; }
            .action-buttons button { width: 100%; }
            .table-controls { flex-direction: column; align-items: stretch; }
            .search-bar { max-width: 100%; }
            .data-table th, .data-table td { padding: 12px 15px; }
        }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; }
            .main-content { padding: 20px; border-radius: 0; }
            .header { flex-direction: column; align-items: flex-start; gap: 10px; padding: 10px 15px; }
            .header-left { width: 100%; justify-content: space-between; gap: 10px; }
            .header-right { width: 100%; justify-content: flex-end; }
            .header-title { font-size: 1.5rem; }
            .header-logo img { height: 80px; width: 80px; }
            .user-info { margin-top: 10px; }
            .user-details { display: none; }
            .request-title, .dashboard-title { font-size: 1.6rem; margin-bottom: 20px; }
            .request-form-section, .table-section { padding: 15px; }
            .request-form-section h2, .table-section h2 { font-size: 1.3em; margin-bottom: 15px; }
            .data-table { min-width: 800px; }
            .data-table th, .data-table td { padding: 10px; font-size: 0.85em; }
            .modal-content { width: 95%; padding: 20px; }
            .form-grid { grid-template-columns: 1fr; }
            .modal-content .form-actions { flex-direction: column; gap: 10px; }
            .modal-content .form-actions button { width: 100%; }
            .modal-close-btn { font-size: 1.3em; top: 10px; right: 10px; }
            .document-modal-controls { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- Full-screen Loading Overlay -->
    <div id="fullScreenLoadingOverlay" class="full-screen-loading-overlay">
        <div class="full-screen-spinner"></div>
    </div>

    <!-- Custom Message Box Overlay for general messages -->
    <div id="customMessageBoxOverlay" class="custom-message-box-overlay">
        <div class="custom-message-box-content">
            <p id="customMessageText"></p>
            <button id="closeCustomMessageBox">Đóng</button>
        </div>
    </div>

    <!-- Custom Confirmation Box Overlay -->
    <div id="confirmationBoxOverlay" class="custom-message-box-overlay">
        <div class="custom-message-box-content">
            <p id="confirmationMessageText"></p>
            <div class="flex justify-center gap-4 mt-4">
                <button id="confirmActionButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Xác nhận</button>
                <button id="cancelActionButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition duration-300">Hủy</button>
            </div>
        </div>
    </div>

    <!-- Document Selection Modal (from RequestCreate.html) -->
    <div id="documentSelectionModal" class="document-modal-overlay">
        <div class="document-modal-content">
            <div class="document-modal-header">
                <h3>Chọn Tài liệu</h3>
                <button class="close-btn" id="closeDocumentModal">&times;</button>
            </div>
            <div class="document-modal-controls">
                <input type="text" id="documentSearchInput" placeholder="Tìm kiếm theo tên hoặc ID...">
                <select id="documentTypeFilter">
                    <option value="">Tất cả loại tài liệu</option>
                    <option value="Giáo trình">Giáo trình</option>
                    <option value="Tài liệu tham khảo">Tài liệu tham khảo</option>
                    <option value="Quy trình">Quy trình</option>
                </select>
            </div>
            <div class="document-list-container" id="documentListContainer">
                <!-- Document items will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal (from Tusision.html) -->
    <div id="imageViewerModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeImageViewerModalBtn">&times;</button>
            <img id="viewerImage" src="" alt="Invoice Image">
        </div>
    </div>

    <!-- Khu vực nội dung chính -->
    <div class="main-content">
        <!-- Tiêu đề -->
        <div class="header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="https://placehold.co/100x100/1a202c/e2e8f0?text=Logo" alt="Trung Tâm Ngoại Ngữ 68">
                </div>
                <div class="header-title">Trung Tâm Ngoại Ngữ 68</div>
            </div>
            <div class="header-right">
                <div id="currentDate" class="header-date"></div>
                <!-- Notification Wrapper (from MajorList.html) -->
                <div class="header-notification-wrapper">
                    <div class="header-icons" id="notificationBellIcon">
                        <!-- Biểu tượng thông báo -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-bell"><path d="M6 8a6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /></svg>
                        <div class="notification-badge" id="notificationCountBadge">0</div>
                    </div>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-dropdown-header">
                            <h3>Thông báo</h3>
                            <button id="clearNotificationsBtn">Xóa tất cả</button>
                        </div>
                        <ul id="notificationList" class="notification-list">
                            <!-- Notifications will be added here by JS -->
                            <li class="text-gray-400 text-sm p-2">Không có thông báo mới.</li>
                        </ul>
                    </div>
                </div>
                <!-- Thông tin người dùng và Dropdown -->
                <div class="user-info" id="userInfo">
                    <img src="https://placehold.co/36x36/1a202c/e2e8f0?text=U" alt="User Avatar" />
                    <div class="user-details">
                        <span class="user-name" id="employeeName">Đang tải...</span>
                        <span class="user-title" id="employeeTitle"></span>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="cursor: pointer; color: #a0aec0;"><path d="m6 9 6 6 6-6" /></svg>
                    <div class="user-dropdown" id="userDropdown">
                        <button id="changePasswordBtn">Đổi Mật Khẩu</button>
                        <button id="logoutBtn">Đăng Xuất</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Request Form Section -->
        <div id="requestFormSection" class="content-section active">
            <h1 class="request-title">Tạo Yêu Cầu Mới</h1>
            <div class="request-form-section">
                <h2>Thông Tin Yêu Cầu</h2>
                <form id="requestForm">
                    <!-- Thông tin nhân viên tạo yêu cầu -->
                    <div class="form-group">
                        <label>Nhân viên tạo yêu cầu:</label>
                        <input type="text" id="requesterName" class="read-only-field" readonly>
                    </div>
                    <div class="form-group">
                        <label>Vai trò:</label>
                        <input type="text" id="requesterRole" class="read-only-field" readonly>
                    </div>

                    <div class="form-group">
                        <label for="requestType">Loại Yêu Cầu:</label>
                        <select id="requestType" required>
                            <option value="">Chọn loại yêu cầu...</option>
                            <option value="student_request">Yêu cầu Học viên (Tạo mới)</option>
                            <option value="edit_student_info_request">Yêu cầu Chỉnh sửa thông tin Học viên</option>
                            <option value="staff_request">Yêu cầu Nhân sự (Tạo mới)</option>
                            <option value="change_staff_info_request">Yêu cầu Thay đổi thông tin Nhân sự</option>
                            <option value="purchase_request">Yêu cầu Mua hàng</option>
                            <option value="class_request">Yêu cầu Lớp học (Tạo mới)</option>
                            <option value="edit_class_request">Yêu cầu Chỉnh sửa Lớp học</option>
                            <option value="create_major_request">Yêu cầu Tạo Chuyên ngành</option>
                            <option value="edit_major_request">Yêu cầu Chỉnh sửa Chuyên ngành</option>
                            <option value="edit_purchase_order_request">Yêu cầu Chỉnh sửa Đơn mua hàng</option>
                            <option value="document_upload_request">Yêu cầu Tài liệu (Tải lên)</option>
                            <option value="document_access_request">Yêu cầu Cấp quyền Truy cập Tài liệu</option>
                            <option value="create_tuition_record_request">Yêu cầu Thêm Học phí mới</option>
                            <option value="edit_tuition_record_request">Yêu cầu Chỉnh sửa Học phí</option>
                            <option value="leave_request">Yêu cầu Xin nghỉ</option>
                        </select>
                    </div>

                    <div id="dynamicFormFields">
                        <!-- Dynamic fields will be loaded here based on requestType -->
                    </div>

                    <div class="form-group" id="requestDescriptionGroup">
                        <label for="requestDescription">Mô tả chi tiết:</label>
                        <textarea id="requestDescription" rows="5" placeholder="Nhập mô tả chi tiết yêu cầu của bạn..." required></textarea>
                    </div>

                    <!-- Người thẩm định -->
                    <div class="form-group">
                        <label for="appraiserSelect">Người thẩm định:</label>
                        <select id="appraiserSelect">
                            <option value="">Chọn người thẩm định (tùy chọn)...</option>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>

                    <!-- Người phê duyệt -->
                    <div class="form-group">
                        <label for="approverSelect">Người phê duyệt:</label>
                        <select id="approverSelect" required>
                            <option value="">Chọn người phê duyệt...</option>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>

                    <!-- Trạng thái của luồng thẩm định và phê duyệt -->
                    <div class="form-group">
                        <label>Trạng thái hiện tại:</label>
                        <input type="text" id="currentStatus" class="read-only-field" value="" readonly>
                        <p class="text-sm text-gray-500 mt-1" id="statusDescription">Trạng thái này sẽ thay đổi khi yêu cầu được xử lý trong luồng công việc.</p>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" id="submitRequestBtn">
                            <i class="fas fa-paper-plane mr-2"></i>Gửi Yêu Cầu
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Removed Tuition Management Section -->
    </div>

    <script>
        // Global functions for modal control
        function openModal(modal) { modal.classList.add('show'); }
        function closeModal(modal) { modal.classList.remove('show'); }

        const fullScreenLoadingOverlay = document.getElementById('fullScreenLoadingOverlay');
        const customMessageBoxOverlay = document.getElementById('customMessageBoxOverlay');
        const customMessageText = document.getElementById('customMessageText');
        const closeCustomMessageBox = document.getElementById('closeCustomMessageBox');
        const confirmationBoxOverlay = document.getElementById('confirmationBoxOverlay');
        const confirmationMessageText = document.getElementById('confirmationMessageText');
        const confirmActionButton = document.getElementById('confirmActionButton');
        const cancelActionButton = document.getElementById('cancelActionButton');

        /**
         * Hiển thị overlay tải toàn màn hình.
         * Displays the full-screen loading overlay.
         */
        function showFullScreenLoading() {
            fullScreenLoadingOverlay.classList.add('active');
        }

        /**
         * Ẩn overlay tải toàn màn hình.
         * Hides the full-screen loading overlay.
         */
        function hideFullScreenLoading() {
            fullScreenLoadingOverlay.classList.remove('active');
        }

        /**
         * Hiển thị một thông báo tùy chỉnh thay vì alert().
         * Displays a custom message instead of alert().
         * @param {string} message - Nội dung thông báo. The message content.
         */
        function showCustomMessage(message) {
            customMessageText.textContent = message;
            customMessageBoxOverlay.classList.add('show');
        }

        closeCustomMessageBox.addEventListener('click', () => {
            customMessageBoxOverlay.classList.remove('show');
        });

        /**
         * Hiển thị hộp thoại xác nhận tùy chỉnh.
         * Displays a custom confirmation box.
         * @param {string} message - Nội dung xác nhận. The confirmation message.
         * @param {function} onConfirm - Hàm callback khi người dùng xác nhận. Callback function when user confirms.
         */
        function showConfirmationBox(message, onConfirm) {
            confirmationMessageText.textContent = message;
            confirmationBoxOverlay.classList.add('show');

            confirmActionButton.onclick = () => {
                showFullScreenLoading();
                confirmationBoxOverlay.classList.remove('show');
                onConfirm();
            };

            cancelActionButton.onclick = () => {
                confirmationBoxOverlay.classList.remove('show');
            };
        }

        // JavaScript để hiển thị ngày và giờ hiện tại
        // JavaScript to display the current date and time.
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('vi-VN', options);
        }
        updateCurrentDate();
        setInterval(updateCurrentDate, 60000);

        // JavaScript để xử lý dropdown người dùng
        // JavaScript to handle user dropdown.
        const userInfo = document.getElementById('userInfo');
        const userDropdown = document.getElementById('userDropdown');

        if (userInfo && userDropdown) {
            userInfo.addEventListener('click', (event) => {
                event.stopPropagation();
                userDropdown.classList.toggle('show');
            });

            document.body.addEventListener('click', (event) => {
                if (userDropdown.classList.contains('show') && !userInfo.contains(event.target)) {
                    userDropdown.classList.remove('show');
                }
            });
        }

      // JavaScript để xử lý dropdown thông báo (Updated to match MajorList.html)
            const notificationBellIcon = document.getElementById('notificationBellIcon'); // Changed ID from notificationIcon
            const notificationDropdown = document.getElementById('notificationDropdown');
            const notificationCountBadge = document.getElementById('notificationCountBadge');
            const notificationList = document.getElementById('notificationList'); // Changed ID from notificationItemsContainer
            const clearNotificationsBtn = document.getElementById('clearNotificationsBtn'); // Changed ID from markAllReadBtn

            // Global array to hold current notifications
            let activeNotifications = [];

            /**
             * Cập nhật số lượng thông báo trên huy hiệu.
             * @param {number} count - Số lượng thông báo chưa đọc.
             */
            function updateNotificationCount(count) {
                if (notificationCountBadge) {
                    notificationCountBadge.textContent = count > 99 ? '99+' : count; // Giới hạn hiển thị 99+
                    if (count > 0) {
                        notificationCountBadge.style.display = 'block';
                    } else {
                        notificationCountBadge.style.display = 'none';
                    }
                }
            }

            /**
             * Adds a new notification to the list.
             * @param {string} id - Unique ID for the notification.
             * @param {string} title - Title of the notification.
             * @param {string} message - Content of the notification.
             * @param {Date} date - Date of the notification.
             * @param {string|null} targetSection - ID of the section to navigate to (e.g., 'addMajorSection', 'viewMajorSection').
             */
            function addNotification(id, title, message, date, targetSection = null) {
                activeNotifications.push({ id, title, message, date, targetSection });
                renderNotifications(activeNotifications);
            }

            /**
             * Checks if two dates are on the same day.
             * @param {Date} d1 - First date.
             * @param {Date} d2 - Second date.
             * @returns {boolean} - True if same day, false otherwise.
             */
            function isSameDay(d1, d2) {
                return d1.getFullYear() === d2.getFullYear() &&
                       d1.getMonth() === d2.getMonth() &&
                       d1.getDate() === d2.getDate();
            }

            /**
             * Determines the time category for a given notification date.
             * @param {Date} notificationDate - The date of the notification.
             * @returns {string} - The time category (e.g., 'Mới', 'Hôm nay', 'Hôm qua').
             */
            function getTimeCategory(notificationDate) {
                const now = new Date();
                const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
                const yesterday = new Date(now);
                yesterday.setDate(now.getDate() - 1);
                yesterday.setHours(0, 0, 0, 0); // Normalize to start of day for accurate comparison

                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
                startOfWeek.setHours(0, 0, 0, 0);

                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                startOfMonth.setHours(0, 0, 0, 0);

                // Normalize notification date for comparison (remove seconds/milliseconds)
                const normalizedNotificationDate = new Date(notificationDate.getFullYear(), notificationDate.getMonth(), notificationDate.getDate(), notificationDate.getHours(), notificationDate.getMinutes());

                if (normalizedNotificationDate > oneHourAgo) {
                    return 'Mới';
                } else if (isSameDay(normalizedNotificationDate, now)) {
                    return 'Hôm nay';
                } else if (isSameDay(normalizedNotificationDate, yesterday)) {
                    return 'Hôm qua';
                } else if (normalizedNotificationDate >= startOfWeek) {
                    return 'Tuần này';
                } else if (normalizedNotificationDate >= startOfMonth) {
                    return 'Tháng này';
                }
                return 'Cũ hơn';
            }

            /**
             * Formats a date into a human-readable "time ago" string.
             * @param {Date} date - The date to format.
             * @returns {string} - Formatted time string.
             */
            function formatTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);

                let interval = seconds / 31536000; // years
                if (interval > 1) {
                    return Math.floor(interval) + " năm trước";
                }
                interval = seconds / 2592000; // months
                if (interval > 1) {
                    return Math.floor(interval) + " tháng trước";
                }
                interval = seconds / 86400; // days
                if (interval > 1) {
                    return Math.floor(interval) + " ngày trước";
                }
                interval = seconds / 3600; // hours
                if (interval > 1) {
                    return Math.floor(interval) + " giờ trước";
                }
                interval = seconds / 60; // minutes
                if (interval > 1) {
                    return Math.floor(interval) + " phút trước";
                }
                return Math.floor(seconds) + " giây trước";
            }

            /**
             * Render notifications into the dropdown, grouped by time.
             * @param {Array<Object>} notifications - Array of notification objects.
             */
            function renderNotifications(notifications) {
                notificationList.innerHTML = ''; // Clear existing notifications
                if (notifications.length === 0) {
                    notificationList.innerHTML = '<li class="text-gray-400 text-sm p-2">Không có thông báo mới.</li>';
                    clearNotificationsBtn.style.display = 'none';
                    updateNotificationCount(0);
                    return;
                }

                clearNotificationsBtn.style.display = 'block';

                // Sort notifications by date, newest first
                notifications.sort((a, b) => b.date.getTime() - a.date.getTime());

                const groupedNotifications = {
                    'Mới': [],
                    'Hôm nay': [],
                    'Hôm qua': [],
                    'Tuần này': [],
                    'Tháng này': [],
                    'Cũ hơn': []
                };

                notifications.forEach(notif => {
                    const category = getTimeCategory(notif.date);
                    // Ensure the category exists before pushing
                    if (!groupedNotifications[category]) {
                        groupedNotifications[category] = [];
                    }
                    groupedNotifications[category].push(notif);
                });

                // Order of categories for rendering
                const categoryOrder = ['Mới', 'Hôm nay', 'Hôm qua', 'Tuần này', 'Tháng này', 'Cũ hơn'];

                categoryOrder.forEach(category => {
                    if (groupedNotifications[category].length > 0) {
                        const categoryHeader = document.createElement('li');
                        categoryHeader.classList.add('notification-category-header'); // Re-using header style for category
                        categoryHeader.innerHTML = `<h3>${category}</h3>`;
                        notificationList.appendChild(categoryHeader);

                        groupedNotifications[category].forEach(notif => {
                            const notificationItem = document.createElement('li');
                            notificationItem.classList.add('notification-item');
                            notificationItem.dataset.id = notif.id; // Assign a unique ID to each notification
                            notificationItem.innerHTML = `
                                <strong>${notif.title}:</strong> ${notif.message}
                                <span class="time">${formatTimeAgo(notif.date)}</span>
                            `;
                            notificationList.appendChild(notificationItem);

                            // Add click listener to each individual notification item
                            notificationItem.addEventListener('click', (event) => {
                                event.stopPropagation(); // Prevent dropdown from closing immediately
                                markNotificationAsRead(notif.id);
                                // No targetSection navigation in StudentInfo.html for now, but keep the parameter for consistency
                                notificationDropdown.classList.remove('show'); // Close dropdown after click
                            });
                        });
                    }
                });
                updateNotificationCount(notifications.length);
            }

            /**
             * Marks a single notification as read and updates the list.
             * @param {string} id - The ID of the notification to mark as read.
             */
            function markNotificationAsRead(id) {
                activeNotifications = activeNotifications.filter(notif => notif.id !== id);
                renderNotifications(activeNotifications);
                showCustomMessage(`Thông báo "${id}" đã được đánh dấu là đã đọc.`);
            }

            // Toggle notification dropdown
            if (notificationBellIcon) {
                notificationBellIcon.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent document click from closing immediately
                    notificationDropdown.classList.toggle('show');
                    // Close user dropdown if open
                    if (userDropdown.classList.contains('show')) {
                        userDropdown.classList.remove('show');
                    }
                });
            }

            // Clear notifications
            if (clearNotificationsBtn) {
                clearNotificationsBtn.addEventListener('click', () => {
                    activeNotifications = []; // Clear all notifications
                    renderNotifications(activeNotifications); // Re-render to show "No notifications"
                    notificationDropdown.classList.remove('show'); // Close dropdown
                    showCustomMessage('Tất cả thông báo đã được đánh dấu là đã đọc.');
                });
            }

            // Close dropdowns when clicking outside
            document.body.addEventListener('click', (event) => {
                if (userDropdown.classList.contains('show') && !userInfo.contains(event.target)) {
                    userDropdown.classList.remove('show');
                }
                if (notificationDropdown.classList.contains('show') && !notificationBellIcon.contains(event.target) && !notificationDropdown.contains(event.target)) {
                    notificationDropdown.classList.remove('show');
                }
            });

            // Initial notifications for the whole app
            activeNotifications = [
                { id: 'notif1', title: 'Thông báo 1', message: 'Học viên mới đã đăng ký.', date: new Date(Date.now() - 30 * 60 * 1000) },
                { id: 'notif2', title: 'Thông báo 2', message: 'Lịch học sắp tới.', date: new Date(Date.now() - 5 * 60 * 60 * 1000) },
                { id: 'notif3', title: 'Thông báo 3', message: 'Yêu cầu hỗ trợ mới.', date: new Date(Date.now() - 24 * 60 * 60 * 1000 - 2 * 60 * 60 * 1000) },
            ];
            renderNotifications(activeNotifications);
        /**
         * Kiểm tra xem hai ngày có cùng ngày, tháng, năm không.
         * Checks if two dates are the same day, month, and year.
         * @param {Date} d1 - Ngày thứ nhất. The first date.
         * @param {Date} d2 - Ngày thứ hai. The second date.
         * @returns {boolean} - True nếu cùng ngày, ngược lại False. True if same day, False otherwise.
         */
        function isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        }

        /**
         * Phân loại thông báo theo thời gian (Mới, Hôm nay, Hôm qua, Tuần này, Tháng này, Cũ hơn).
         * Categorizes notifications by time (New, Today, Yesterday, This Week, This Month, Older).
         * @param {Date} notificationDate - Ngày của thông báo. The notification date.
         * @returns {string} - Tên danh mục thời gian. The time category name.
         */
        function getTimeCategory(notificationDate) {
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);
            yesterday.setHours(0, 0, 0, 0);

            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);

            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            startOfMonth.setHours(0, 0, 0, 0);

            notificationDate.setSeconds(0, 0);

            if (notificationDate > oneHourAgo) {
                return 'Mới';
            } else if (isSameDay(notificationDate, now)) {
                return 'Hôm nay';
            } else if (isSameDay(notificationDate, yesterday)) {
                return 'Hôm qua';
            } else if (notificationDate >= startOfWeek) {
                return 'Tuần này';
            } else if (notificationDate >= startOfMonth) {
                return 'Tháng này';
            }
            return 'Cũ hơn';
        }

        /**
         * Định dạng thời gian thành "X phút/giờ/ngày trước".
         * Formats time into "X minutes/hours/days ago".
         * @param {Date} date - Đối tượng ngày để định dạng. The date object to format.
         * @returns {string} - Chuỗi thời gian đã định dạng. The formatted time string.
         */
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) {
                return Math.floor(interval) + " năm trước";
            }
            interval = seconds / 2592000;
            if (interval > 1) {
                return Math.floor(interval) + " tháng trước";
            }
            interval = seconds / 86400;
            if (interval > 1) {
                return Math.floor(interval) + " ngày trước";
            }
            interval = seconds / 3600;
            if (interval > 1) {
                return Math.floor(interval) + " giờ trước";
            }
            return Math.floor(seconds) + " giây trước";
        }

        /**
         * Hiển thị danh sách thông báo trong dropdown.
         * Displays the list of notifications in the dropdown.
         * @param {Array<Object>} notifications - Mảng các đối tượng thông báo. Array of notification objects.
         */
        function renderNotifications(notifications) {
            notificationItemsContainer.innerHTML = '';
            if (notifications.length === 0) {
                noNotificationsMessage.style.display = 'block';
                markAllReadBtn.style.display = 'none';
                updateNotificationCount(0);
                return;
            }

            noNotificationsMessage.style.display = 'none';
            markAllReadBtn.style.display = 'block';

            notifications.sort((a, b) => b.date.getTime() - a.date.getTime());

            const groupedNotifications = {
                'Mới': [],
                'Hôm nay': [],
                'Hôm qua': [],
                'Tuần này': [],
                'Tháng này': [],
                'Cũ hơn': []
            };

            notifications.forEach(notif => {
                const category = getTimeCategory(notif.date);
                if (!groupedNotifications[category]) {
                    groupedNotifications[category] = [];
                }
                groupedNotifications[category].push(notif);
            });

            const categoryOrder = ['Mới', 'Hôm nay', 'Hôm qua', 'Tuần này', 'Tháng này', 'Cũ hơn'];

            categoryOrder.forEach(category => {
                if (groupedNotifications[category].length > 0) {
                    const categoryHeader = document.createElement('div');
                    categoryHeader.classList.add('notification-category-header');
                    categoryHeader.textContent = category;
                    notificationItemsContainer.appendChild(categoryHeader);

                    groupedNotifications[category].forEach(notif => {
                        const notificationItem = document.createElement('div');
                        notificationItem.classList.add('notification-item');
                        notificationItem.dataset.id = notif.id;
                        notificationItem.innerHTML = `
                            <strong>${notif.title}:</strong> ${notif.message}
                            <span class="time">${formatTimeAgo(notif.date)}</span>
                        `;
                        notificationItemsContainer.appendChild(notificationItem);

                        notificationItem.addEventListener('click', (event) => {
                            event.stopPropagation();
                            markNotificationAsRead(notif.id);
                        });
                    });
                }
            });
            updateNotificationCount(notifications.length);
        }

        /**
         * Đánh dấu một thông báo là đã đọc và cập nhật danh sách.
         * Marks a notification as read and updates the list.
         * @param {string} id - ID của thông báo cần đánh dấu. The ID of the notification to mark.
         */
        function markNotificationAsRead(id) {
            activeNotifications = activeNotifications.filter(notif => notif.id !== id);
            renderNotifications(activeNotifications);
            showCustomMessage(`Thông báo "${id}" đã được đánh dấu là đã đọc.`);
            notificationDropdown.classList.remove('show');
        }

        // Initial notifications for the whole app
        activeNotifications = [
            { id: 'notif1', title: 'Thông báo 1', message: 'Học viên mới đã đăng ký.', date: new Date(Date.now() - 30 * 60 * 1000) },
            { id: 'notif2', title: 'Thông báo 2', message: 'Lịch học sắp tới.', date: new Date(Date.now() - 5 * 60 * 60 * 1000) },
            { id: 'notif3', title: 'Thông báo 3', message: 'Yêu cầu hỗ trợ mới.', date: new Date(Date.now() - 24 * 60 * 60 * 1000 - 2 * 60 * 60 * 1000) },
        ];
        renderNotifications(activeNotifications);

        if (notificationIcon && notificationDropdown) {
            notificationIcon.addEventListener('click', (event) => {
                event.stopPropagation();
                notificationDropdown.classList.toggle('show');
            });

            document.body.addEventListener('click', (event) => {
                if (notificationDropdown.classList.contains('show') && !notificationIcon.contains(event.target) && !notificationDropdown.contains(event.target)) {
                    notificationDropdown.classList.remove('show');
                }
            });
        }

        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', () => {
                activeNotifications = [];
                renderNotifications(activeNotifications);
                notificationDropdown.classList.remove('show');
                showCustomMessage('Tất cả thông báo đã được đánh dấu là đã đọc.');
            });
        }

        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        if (changePasswordBtn) {
            changePasswordBtn.addEventListener('click', () => {
                showFullScreenLoading();
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage(JSON.stringify({ type: 'ShowChangePasswordDialog' }));
                } else {
                    showCustomMessage('Chức năng đổi mật khẩu chỉ khả dụng trong ứng dụng Windows Forms.');
                }
                userDropdown.classList.remove('show');
                setTimeout(hideFullScreenLoading, 1000);
            });
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage(JSON.stringify({ type: 'Logout' }));
                } else {
                    showCustomMessage('Chức năng đăng xuất chỉ khả dụng trong ứng dụng Windows Forms.');
                }
                userDropdown.classList.remove('show');
            });
        }

        const requesterNameInput = document.getElementById('requesterName');
        const requesterRoleInput = document.getElementById('requesterRole');

        /**
         * Đặt tên người dùng đã đăng nhập vào các trường liên quan.
         * Sets the logged-in user's name in related fields.
         * @param {string} name - Tên người dùng. The user's name.
         */
        function setLoggedInUserName(name) {
            const userNameSpan = document.getElementById('employeeName');
            if (userNameSpan) {
                userNameSpan.textContent = name;
                // Only update requesterNameInput if it exists (i.e., if requestFormSection is active)
                if (requesterNameInput) {
                    requesterNameInput.value = name;
                }
            }
        }

        /**
         * Đặt chức danh người dùng đã đăng nhập vào các trường liên quan.
         * Sets the logged-in user's title in related fields.
         * @param {string} title - Chức danh người dùng. The user's title.
         */
        function setLoggedInUserTitle(title) {
            const userTitleSpan = document.getElementById('employeeTitle');
            if (userTitleSpan) {
                userTitleSpan.textContent = title;
                // Only update requesterRoleInput if it exists
                if (requesterRoleInput) {
                    requesterRoleInput.value = title;
                }
            }
        }

        // --- Request Form Logic ---
        const requestTypeSelect = document.getElementById('requestType');
        const dynamicFormFieldsDiv = document.getElementById('dynamicFormFields');
        const requestForm = document.getElementById('requestForm');
        const appraiserSelect = document.getElementById('appraiserSelect');
        const approverSelect = document.getElementById('approverSelect');
        const currentStatusInput = document.getElementById('currentStatus');
        const statusDescription = document.getElementById('statusDescription');
        const requestDescriptionGroup = document.getElementById('requestDescriptionGroup'); // Get the group div
        const requestDescriptionInput = document.getElementById('requestDescription'); // Get the textarea

        // Mock data for dropdowns
        const mockGenders = ['Nam', 'Nữ', 'Khác'];
        const mockBranches = ['Chi nhánh Hà Nội', 'Chi nhánh TP.HCM', 'Chi nhánh Đà Nẵng'];
        const mockClasses = ['Lớp A1', 'Lớp B2', 'Lớp C1', 'Lớp IELTS'];
        const mockStudentStatusesForNewRequest = ['Đang chờ xếp lớp', 'Chờ khai giảng', 'Đã xếp lớp'];
        const mockDepartments = ['Phòng Đào tạo', 'Phòng Tuyển sinh', 'Phòng Kế toán', 'Phòng Quản lý Học viên'];
        const mockContractTypes = ['Hợp đồng chính thức', 'Hợp đồng thử việc', 'Hợp đồng cộng tác viên'];
        const mockPositions = [
            'Giám đốc', 'Trưởng phòng', 'Quản lý', 'Nhân viên', 'Tư vấn viên', 'Giáo viên', 'Kế toán'
        ];
        const mockMajors = ['Tiếng Anh', 'Tiếng Nhật', 'Tiếng Hàn', 'Tiếng Trung'];
        const mockClassLevels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2', 'IELTS', 'TOEFL'];
        const mockTeachers = ['Nguyễn Văn A', 'Trần Thị B', 'Lê Văn C', 'Phạm Thị D'];
        const mockTeachingAssistants = ['Trợ giảng A', 'Trợ giảng B', 'Trợ giảng C', 'Không có'];
        const mockClassStatuses = ['Đang hoạt động', 'Chờ khai giảng', 'Đã kết thúc', 'Hủy'];
        const mockWeekDays = ['Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy', 'Chủ Nhật'];
        const mockLeaveTypes = ['Nghỉ phép', 'Nghỉ ốm', 'Nghỉ không lương', 'Nghỉ thai sản', 'Nghỉ việc riêng', 'Khác'];
        const mockLeavePeriodTypes = [{ value: 'by_day', text: 'Nghỉ theo ngày' }, { value: 'by_hour', text: 'Nghỉ theo giờ' }];


        // Mock data for existing classes (for edit request)
        const mockExistingClasses = [
            {
                id: 'C001',
                name: 'Lớp IELTS 7.0 - Tối 3-5',
                major: 'Tiếng Anh',
                teacher: 'Nguyễn Văn A',
                teachingAssistant: 'Trợ giảng A',
                room: 'Phòng 101',
                startDate: '2024-08-01',
                endDate: '2024-11-30',
                status: 'Đang hoạt động',
                maxStudents: '20',
                scheduleTimeStart: '19:00',
                scheduleTimeEnd: '21:00',
                scheduleDays: ['Thứ Ba', 'Thứ Năm']
            },
            {
                id: 'C002',
                name: 'Lớp Giao tiếp B1 - Sáng 2-4-6',
                major: 'Tiếng Anh',
                teacher: 'Trần Thị B',
                teachingAssistant: 'Không có',
                room: 'Phòng 203',
                startDate: '2024-07-15',
                endDate: '2024-10-15',
                status: 'Chờ khai giảng',
                maxStudents: '15',
                scheduleTimeStart: '09:00',
                scheduleTimeEnd: '11:00',
                scheduleDays: ['Thứ Hai', 'Thứ Tư', 'Thứ Sáu']
            },
            {
                id: 'C003',
                name: 'Lớp TOEIC 500+ - Tối 2-4',
                major: 'Tiếng Anh',
                teacher: 'Lê Văn C',
                teachingAssistant: 'Trợ giảng B',
                room: 'Phòng 305',
                startDate: '2024-05-01',
                endDate: '2024-07-30',
                status: 'Đã kết thúc',
                maxStudents: '25',
                scheduleTimeStart: '18:30',
                scheduleTimeEnd: '20:30',
                scheduleDays: ['Thứ Hai', 'Thứ Tư']
            },
        ];

        // Mock data for existing staff members (for change_staff_info_request)
        const mockExistingStaff = [
            {
                id: 'NV001',
                fullName: 'Nguyễn Thị Hương',
                branch: 'Chi nhánh Hà Nội',
                department: 'Phòng Đào tạo',
                position: 'Giáo viên',
                phone: '0912345678',
                email: 'huong.nguyen@example.com',
                address: 'Số 10, Ngõ 20, Đường ABC, Hà Nội',
                contractType: 'Hợp đồng chính thức',
                bankAccount: '1234567890',
                bankBranch: 'Vietcombank - Ba Đình',
                certificates: 'Chứng chỉ TESOL, IELTS 8.0'
            },
            {
                id: 'NV002',
                fullName: 'Trần Văn Long',
                branch: 'Chi nhánh TP.HCM',
                department: 'Phòng Tuyển sinh',
                position: 'Tư vấn viên',
                phone: '0987654321',
                email: 'long.tran@example.com',
                address: '456 Đường XYZ, Quận 1, TP.HCM',
                contractType: 'Hợp đồng thử việc',
                bankAccount: '0987654321',
                bankBranch: 'Techcombank - Quận 1',
                certificates: 'Chứng chỉ tư vấn'
            },
            {
                id: 'NV003',
                fullName: 'Phạm Thu Thảo',
                branch: 'Chi nhánh Đà Nẵng',
                department: 'Phòng Kế toán',
                position: 'Kế toán',
                phone: '0900112233',
                email: 'thao.pham@example.com',
                address: '789 Đường DEF, Quận Hải Châu, Đà Nẵng',
                contractType: 'Hợp đồng chính thức',
                bankAccount: '1122334455',
                bankBranch: 'BIDV - Hải Châu',
                certificates: 'Chứng chỉ Kế toán trưởng'
            }
        ];

        // Mock data for existing students
        const mockExistingStudents = [
            {
                id: 'HV001',
                fullName: 'Lê Minh Anh',
                gender: 'Nữ',
                idCard: '123456789012',
                dob: '2000-01-15',
                address: '123 Đường ABC, Quận 1, TP.HCM',
                phone: '0901112222',
                email: 'minhanh.le@example.com',
                branch: 'Chi nhánh TP.HCM',
                consultant: 'Trần Thị B',
                class: 'Lớp IELTS 7.0 - Tối 3-5',
                entryLevel: 'IELTS 6.0',
                status: 'Đang học'
            },
            {
                id: 'HV002',
                fullName: 'Trần Văn Đạt',
                gender: 'Nam',
                idCard: '987654321098',
                dob: '1998-05-20',
                address: '456 Phố XYZ, Quận Ba Đình, Hà Nội',
                phone: '0987776666',
                email: 'vandat.tran@example.com',
                branch: 'Chi nhánh Hà Nội',
                consultant: 'Nguyễn Văn A',
                class: 'Lớp Giao tiếp B1 - Sáng 2-4-6',
                entryLevel: 'A2',
                status: 'Đang học'
            },
            {
                id: 'HV003',
                fullName: 'Nguyễn Thị Thu',
                gender: 'Nữ',
                idCard: '112233445566',
                dob: '2002-11-01',
                address: '789 Đường DEF, Quận Hải Châu, Đà Nẵng',
                phone: '0909998888',
                email: 'thuthu.nguyen@example.com',
                branch: 'Chi nhánh Đà Nẵng',
                consultant: 'Phạm Hải D',
                class: 'Lớp TOEIC 500+ - Tối 2-4',
                entryLevel: 'TOEIC 450',
                status: 'Bảo lưu'
            }
        ];


        // Mock data for existing documents (for document access request)
        const mockExistingDocuments = [
            { id: 'DOC001', name: 'Giáo trình IELTS Cấp tốc', type: 'Giáo trình', path: '/documents/giao_trinh/ielts_cap_toc.pdf' },
            { id: 'DOC002', name: 'Quy trình Tuyển sinh 2024', type: 'Quy trình', path: '/documents/quy_trinh/tuyen_sinh_2024.pdf' },
            { id: 'DOC003', name: 'Tài liệu Tham khảo Ngữ pháp Nâng cao', type: 'Tài liệu tham khảo', path: '/documents/tai_lieu/ngu_phap_nang_cao.docx' },
            { id: 'DOC004', name: 'Chính sách Bảo mật Thông tin Học viên', type: 'Quy trình', path: '/documents/quy_trinh/chinh_sach_bao_mat.pdf' },
            { id: 'DOC005', name: 'Hướng dẫn sử dụng hệ thống CRM', type: 'Quy trình', path: '/documents/quy_trinh/huong_dan_crm.pdf' },
            { id: 'DOC006', name: 'Báo cáo tài chính Quý 1 2024', type: 'Tài liệu tham khảo', path: '/documents/bao_cao/bao_cao_tai_chinh_Q1_2024.xlsx' },
            { id: 'DOC007', name: 'Giáo trình Tiếng Anh Giao tiếp Cơ bản', type: 'Giáo trình', path: '/documents/giao_trinh/tieng_anh_giao_tiep_co_ban.pdf' },
            { id: 'DOC008', name: 'Quy định về chấm công và nghỉ phép', type: 'Quy trình', path: '/documents/quy_trinh/cham_cong_nghi_phep.pdf' },
            { id: 'DOC009', name: 'Tài liệu ôn thi TOEIC', type: 'Tài liệu tham khảo', path: '/documents/tai_lieu/on_thi_toeic.pdf' },
            { id: 'DOC010', name: 'Sổ tay nhân viên mới', type: 'Quy trình', path: '/documents/quy_trinh/so_tay_nhan_vien_moi.pdf' },
            { id: 'DOC011', name: 'Giáo trình Tiếng Nhật N5', type: 'Giáo trình', path: '/documents/giao_trinh/tieng_nhat_N5.pdf' },
            { id: 'DOC012', name: 'Quy trình Đánh giá Hiệu suất Nhân viên', type: 'Quy trình', path: '/documents/quy_trinh/danh_gia_hieu_suat.pdf' },
            { id: 'DOC013', name: 'Tài liệu Hướng dẫn IELTS Writing Task 2', type: 'Tài liệu tham khảo', path: '/documents/tai_lieu/ielts_writing_task2.pdf' },
            { id: 'DOC014', name: 'Chính sách Đào tạo và Phát triển', type: 'Quy trình', path: '/documents/quy_trinh/dao_tao_phat_trien.pdf' },
            { id: 'DOC015', name: 'Báo cáo Doanh số Tháng 6', type: 'Tài liệu tham khảo', path: '/documents/bao_cao/doanh_so_thang_6.xlsx' },
            { id: 'DOC016', name: 'Giáo trình Tiếng Trung HSK1', type: 'Giáo trình', path: '/documents/giao_trinh/tieng_trung_hsk1.pdf' },
            { id: 'DOC017', name: 'Quy trình Xử lý Khiếu nại Học viên', type: 'Quy trình', path: '/documents/quy_trinh/xu_ly_khieu_nai.pdf' },
            { id: 'DOC018', name: 'Tài liệu Luyện nghe TOEIC Part 3', type: 'Tài liệu tham khảo', path: '/documents/tai_lieu/luyen_nghe_toeic_part3.mp3' },
            { id: 'DOC019', name: 'Sổ tay An toàn Lao động', type: 'Quy trình', path: '/documents/quy_trình/an_toan_lao_dong.pdf' },
            { id: 'DOC020', name: 'Giáo trình Tiếng Hàn Sơ cấp 1', type: 'Giáo trình', path: '/documents/giao_trinh/tieng_han_so_cap1.pdf' },
        ];


        // Mock data for consultant staff accounts and display names
        const mockConsultantAccounts = [
            { account: 'nv_anv', displayName: 'Nguyễn Văn A' },
            { account: 'tt_b', displayName: 'Trần Thị B' },
            { account: 'lv_c', displayName: 'Lê Văn C' },
            { account: 'ph_d', displayName: 'Phạm Hải D' },
            { account: 'ht_e', displayName: 'Hoàng Thị E' }
        ];

        // Mock data for existing purchase orders
        const mockExistingPurchaseOrders = [
            {
                id: 'PO001',
                item: 'Bút bi Thiên Long',
                quantity: 100,
                unitPrice: 5000,
                status: 'Đã đặt hàng',
                expectedDeliveryDate: '2024-07-25',
                supplier: 'Công ty Văn phòng phẩm ABC'
            },
            {
                id: 'PO002',
                item: 'Giấy A4 Double A',
                quantity: 50,
                unitPrice: 60000,
                status: 'Đang vận chuyển',
                expectedDeliveryDate: '2024-07-28',
                supplier: 'Nhà phân phối Giấy XYZ'
            },
            {
                id: 'PO003',
                item: 'Mực in Canon PG-810',
                quantity: 10,
                unitPrice: 250000,
                status: 'Đã giao hàng',
                expectedDeliveryDate: '2024-07-20',
                supplier: 'Cửa hàng Thiết bị Văn phòng DEF'
            }
        ];

        // Mock data for existing majors (for edit major request)
        const mockExistingMajors = [
            { name: 'Tiếng Anh', numLessons: 40, tuitionFee: 8000000 },
            { name: 'Tiếng Nhật', numLessons: 30, tuitionFee: 7500000 },
            { name: 'Tiếng Hàn', numLessons: 35, tuitionFee: 7000000 },
            { name: 'Tiếng Trung', numLessons: 50, tuitionFee: 9000000 }
        ];

        // Mock data for Tuition Management (re-using some from original Tusision.html)
        const mockTuitionStudents = [
            { id: 101, name: "Nguyễn Thị An" },
            { id: 102, name: "Trần Văn Bình" },
            { id: 103, name: "Lê Thị Cúc" }
        ];

        const mockTuitionMajors = [
            { id: 1, name: "Tiếng Anh Giao Tiếp", baseTuition: 2500000 },
            { id: 2, name: "Luyện Thi IELTS", baseTuition: 6000000 },
            { id: 3, name: "Tiếng Trung HSK3", baseTuition: 4000000 }
        ];

        const mockTuitionPaymentStatuses = [
            { value: "paid", text: "Đã thanh toán" },
            { value: "partially_paid", text: "Thanh toán một phần" },
            { value: "unpaid", text: "Chưa thanh toán" }
        ];

        const mockTuitionCompletionStatuses = [
            { value: "not_started", text: "Chưa hoàn thành" },
            { value: "in_progress", text: "Đang tiến hành" },
            { value: "completed", text: "Đã hoàn thành" }
        ];

        const mockTuitionPaymentMethods = [
            { value: "bank_transfer", text: "Chuyển khoản" },
            { value: "cash", text: "Tiền mặt" },
            { value: "credit_card", text: "Thẻ tín dụng" }
        ];

        const placeholderImageUrl = "https://placehold.co/800x600/E0E0E0/333333?text=Ảnh+Hóa+Đơn+Placeholder";

        // Định nghĩa cấu hình các trường cho từng loại yêu cầu
        // Defines the field configurations for each request type.
        const requestFields = {
            'student_request': [
                { id: 'studentFullName', label: 'Họ và tên:', type: 'text', placeholder: 'Nhập họ và tên' },
                { id: 'studentGender', label: 'Giới tính:', type: 'select', options: mockGenders },
                { id: 'studentIDCard', label: 'Số CMND/CCCD:', type: 'text', placeholder: 'Nhập số CMND/CCCD' },
                { id: 'studentDOB', label: 'Ngày sinh:', type: 'date' },
                { id: 'studentAddress', label: 'Địa chỉ:', type: 'text', placeholder: 'Nhập địa chỉ' },
                { id: 'studentPhone', label: 'Số điện thoại:', type: 'tel', placeholder: 'Nhập số điện thoại' },
                { id: 'studentEmail', label: 'Email:', type: 'email', placeholder: 'Nhập email học viên' },
                { id: 'studentBranch', label: 'Chi nhánh:', type: 'select', options: mockBranches },
                { id: 'studentConsultant', label: 'Nhân viên tư vấn (Tên tài khoản):', type: 'text', placeholder: 'Nhập tên tài khoản (vd: nv_anv)' },
                { id: 'studentClass', label: 'Lớp:', type: 'select', options: mockClasses },
                { id: 'studentEntryLevel', label: 'Trình độ đầu vào:', type: 'text', placeholder: 'Nhập trình độ đầu vào' },
                { id: 'studentStatus', label: 'Trạng thái:', type: 'select', options: mockStudentStatusesForNewRequest }
            ],
            'edit_student_info_request': [
                { id: 'studentToEditId', label: 'Chọn Học viên cần chỉnh sửa:', type: 'select', options: mockExistingStudents.map(s => `${s.id} - ${s.fullName}`), required: true, placeholder: 'Chọn học viên...' },
                { id: 'newStudentPhone', label: 'Số điện thoại:', type: 'tel', placeholder: 'Nhập số điện thoại mới', optional: true },
                { id: 'newStudentEmail', label: 'E-mail:', type: 'email', placeholder: 'Nhập email mới', optional: true },
                { id: 'newStudentAddress', label: 'Địa chỉ:', type: 'text', placeholder: 'Nhập địa chỉ mới', optional: true },
                { id: 'newStudentBranch', label: 'Chi nhánh:', type: 'select', options: ['Không thay đổi', ...mockBranches], optional: true },
                { id: 'newStudentConsultant', label: 'Nhân viên tư vấn (Tên tài khoản):', type: 'text', placeholder: 'Nhập tên tài khoản (vd: nv_anv)', optional: true },
                { id: 'newStudentClass', label: 'Lớp:', type: 'select', options: ['Không thay đổi', ...mockClasses], optional: true },
                { id: 'newStudentEntryLevel', label: 'Trình độ đầu vào:', type: 'text', placeholder: 'Nhập trình độ đầu vào mới', optional: true },
                { id: 'newStudentStatus', label: 'Trạng thái:', type: 'select', options: ['Không thay đổi', ...mockStudentStatusesForNewRequest, 'Đang học', 'Đã tốt nghiệp', 'Bảo lưu', 'Thôi học'], optional: true }
            ],
            'staff_request': [
                { id: 'staffBranch', label: 'Chi nhánh làm việc:', type: 'select', options: mockBranches },
                { id: 'staffDepartment', label: 'Bộ phận:', type: 'select', options: mockDepartments },
                { id: 'staffPosition', label: 'Chức vụ:', type: 'select', options: mockPositions },
                { id: 'staffId', label: 'Mã nhân viên:', type: 'text', readOnly: true, value: 'NN68' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0') },
                { id: 'staffFullName', label: 'Họ tên nhân viên:', type: 'text', placeholder: 'Nhập họ tên nhân viên' },
                { id: 'staffGender', label: 'Giới tính:', type: 'select', options: mockGenders },
                { id: 'staffIDCard', label: 'Số CCCD/Hộ chiếu:', type: 'text', placeholder: 'Nhập số CCCD/Hộ chiếu' },
                { id: 'staffDOB', label: 'Ngày sinh:', type: 'date' },
                { id: 'staffAddress', label: 'Địa chỉ:', type: 'text', placeholder: 'Nhập địa chỉ' },
                { id: 'staffPhone', label: 'Số điện thoại:', type: 'tel', placeholder: 'Nhập số điện thoại' },
                { id: 'staffEmail', label: 'E-mail:', type: 'email', placeholder: 'Nhập email' },
                { id: 'staffCertificates', label: 'Chứng chỉ/Bằng cấp (Mô tả):', type: 'textarea', placeholder: 'Liệt kê các chứng chỉ, bằng cấp' },
                { id: 'staffCertificateFiles', label: 'Tệp chứng chỉ/bằng cấp:', type: 'file', multiple: true, accept: 'image/*,application/pdf' },
                { id: 'staffContractType', label: 'Loại hợp đồng:', type: 'select', options: mockContractTypes },
                { id: 'staffContractCode', label: 'Mã số hợp đồng:', type: 'text', placeholder: 'Nhập mã số hợp đồng' },
                { id: 'staffJoinDate', label: 'Ngày gia nhập:', type: 'date' },
                { id: 'staffSocialInsuranceCode', label: 'Số sổ bảo hiểm xã hội (nếu có):', type: 'text', placeholder: 'Nhập số sổ bảo hiểm xã hội' },
                { id: 'staffTaxCode', label: 'Mã số thuế (nếu có):', type: 'text', placeholder: 'Nhập mã số thuế' },
                { id: 'staffBankBranch', label: 'Chi nhánh ngân hàng:', type: 'text', placeholder: 'Nhập chi nhánh ngân hàng' },
                { id: 'staffBankAccount', label: 'Số tài khoản ngân hàng:', type: 'text', placeholder: 'Nhập số tài khoản ngân hàng' }
            ],
            'change_staff_info_request': [
                { id: 'staffToEditId', label: 'Chọn Nhân sự cần chỉnh sửa:', type: 'select', options: mockExistingStaff.map(s => `${s.id} - ${s.fullName}`), required: true, placeholder: 'Chọn nhân sự...' },
                { id: 'newStaffBranch', label: 'Chi nhánh làm việc:', type: 'select', options: ['Không thay đổi', ...mockBranches], optional: true },
                { id: 'newStaffDepartment', label: 'Bộ phận:', type: 'select', options: ['Không thay đổi', ...mockDepartments], optional: true },
                { id: 'newStaffPosition', label: 'Chức vụ:', type: 'select', options: ['Không thay đổi', ...mockPositions], optional: true },
                { id: 'newStaffPhone', label: 'Số điện thoại:', type: 'tel', placeholder: 'Nhập số điện thoại', optional: true },
                { id: 'newStaffEmail', label: 'E-mail:', type: 'email', placeholder: 'Nhập email', optional: true },
                { id: 'newStaffAddress', label: 'Địa chỉ:', type: 'text', placeholder: 'Nhập địa chỉ', optional: true },
                { id: 'newStaffContractType', label: 'Loại hợp đồng:', type: 'select', options: ['Không thay đổi', ...mockContractTypes], optional: true },
                { id: 'newStaffBankAccount', label: 'Số tài khoản ngân hàng:', type: 'text', placeholder: 'Nhập số tài khoản ngân hàng', optional: true },
                { id: 'newStaffBankBranch', label: 'Chi nhánh ngân hàng:', type: 'text', placeholder: 'Nhập chi nhánh ngân hàng', optional: true },
                { id: 'newStaffCertificates', label: 'Chứng chỉ/Bằng cấp (Mô tả):', type: 'textarea', placeholder: 'Liệt kê các chứng chỉ, bằng cấp', optional: true },
                { id: 'newStaffCertificateFiles', label: 'Tệp chứng chỉ/bằng cấp:', type: 'file', multiple: true, accept: 'image/*,application/pdf', optional: true }
            ],
            'purchase_request': [
                { id: 'itemName', label: 'Tên mặt hàng:', type: 'text', placeholder: 'Nhập tên mặt hàng (ví dụ: Bút bi, Giấy A4)', required: true },
                { id: 'quantity', label: 'Số lượng:', type: 'text', placeholder: 'Nhập số lượng', required: true },
                { id: 'unitPrice', label: 'Đơn giá (VNĐ):', type: 'text', placeholder: 'Nhập đơn giá', required: true, format: 'currency' },
                { id: 'supplier', label: 'Nhà cung cấp:', type: 'text', placeholder: 'Nhập tên nhà cung cấp', required: true },
                { id: 'expectedDeliveryDate', label: 'Ngày giao hàng dự kiến:', type: 'date', required: true },
                { id: 'status', label: 'Trạng thái đơn hàng:', type: 'select', options: ['Đã đặt hàng', 'Đang vận chuyển', 'Đã giao hàng', 'Đã hủy'], required: true },
                { id: 'supportingDocuments', label: 'Tài liệu đính kèm (báo giá, hóa đơn):', type: 'file', multiple: true, accept: 'image/*,application/pdf', optional: true }
            ],
            'class_request': [
                { id: 'classMajor', label: 'Chuyên ngành:', type: 'select', options: mockMajors },
                { id: 'className', label: 'Tên lớp:', type: 'text', readOnly: true, placeholder: 'Tên lớp sẽ được tạo tự động' },
                { id: 'classTeacher', label: 'Giáo viên chính:', type: 'select', options: mockTeachers },
                { id: 'classTeachingAssistant', label: 'Trợ giảng (nếu có):', type: 'select', options: mockTeachingAssistants },
                { id: 'classRoom', label: 'Phòng học:', type: 'text', placeholder: 'Nhập tên hoặc số phòng học' },
                { id: 'classStartDate', label: 'Ngày bắt đầu lớp học:', type: 'date', readOnly: true },
                { id: 'classEndDate', label: 'Ngày kết thúc dự kiến:', type: 'date', readOnly: true },
                { id: 'classStatus', label: 'Trạng thái lớp học:', type: 'select', options: mockClassStatuses },
                { id: 'classMaxStudents', label: 'Số lượng học viên tối đa:', type: 'text', placeholder: 'Nhập số lượng học viên tối đa' },
                { id: 'classScheduleTimeStart', label: 'Giờ bắt đầu:', type: 'time' },
                { id: 'classScheduleTimeEnd', label: 'Giờ kết thúc:', type: 'time' },
                { id: 'classScheduleDays', label: 'Chọn các ngày trong tuần:', type: 'checkbox-group', options: mockWeekDays }
            ],
            'edit_class_request': [
                { id: 'classToEditId', label: 'Mã/Tên Lớp học cần chỉnh sửa:', type: 'select', options: mockExistingClasses.map(cls => `${cls.id} - ${cls.name}`), required: true, placeholder: 'Chọn lớp học cần chỉnh sửa' },
                { id: 'newClassTeacher', label: 'Giáo viên chính:', type: 'select', options: ['Không thay đổi', ...mockTeachers], optional: true },
                { id: 'newClassTeachingAssistant', label: 'Trợ giảng:', type: 'select', options: ['Không thay đổi', ...mockTeachingAssistants], optional: true },
                { id: 'newClassRoom', label: 'Phòng học:', type: 'text', placeholder: 'Nhập tên hoặc số phòng học', optional: true },
                { id: 'newClassStartDate', label: 'Ngày bắt đầu:', type: 'date', readOnly: true, optional: true },
                { id: 'newClassEndDate', label: 'Ngày kết thúc:', type: 'date', readOnly: true, optional: true },
                { id: 'newClassStatus', label: 'Trạng thái lớp học:', type: 'select', options: ['Không thay đổi', ...mockClassStatuses], optional: true },
                { id: 'newClassMaxStudents', label: 'Số lượng học viên tối đa:', type: 'text', placeholder: 'Nhập số lượng học viên tối đa', optional: true },
                { id: 'newClassScheduleTimeStart', label: 'Giờ bắt đầu:', type: 'time', optional: true },
                { id: 'newClassScheduleTimeEnd', label: 'Giờ kết thúc:', type: 'time', optional: true },
                { id: 'newClassScheduleDays', label: 'Các ngày trong tuần:', type: 'checkbox-group', options: mockWeekDays, optional: true }
            ],
            'create_major_request': [
                { id: 'majorName', label: 'Tên Chuyên ngành:', type: 'text', placeholder: 'Nhập tên chuyên ngành mới', required: true },
                { id: 'majorNumLessons', label: 'Số buổi học:', type: 'text', placeholder: 'Nhập số buổi học (ví dụ: 20)', required: true },
                { id: 'majorTuitionFee', label: 'Học phí (VNĐ):', type: 'text', placeholder: 'Nhập học phí (ví dụ: 5.000.000)', required: true, format: 'currency' }
            ],
            'edit_major_request': [
                { id: 'majorToEdit', label: 'Chọn Chuyên ngành cần chỉnh sửa:', type: 'select', options: mockMajors, required: true, placeholder: 'Chọn chuyên ngành...' },
                { id: 'newMajorName', label: 'Tên Chuyên ngành mới:', type: 'text', placeholder: 'Nhập tên chuyên ngành mới', optional: true },
                { id: 'newMajorNumLessons', label: 'Số buổi học mới:', type: 'text', placeholder: 'Nhập số buổi học mới (ví dụ: 25)', optional: true },
                { id: 'newMajorTuitionFee', label: 'Học phí mới (VNĐ):', type: 'text', placeholder: 'Nhập học phí mới (ví dụ: 6.000.000)', optional: true, format: 'currency' }
            ],
            'edit_purchase_order_request': [
                { id: 'purchaseOrderToEditId', label: 'Chọn Đơn mua hàng cần chỉnh sửa:', type: 'select', options: mockExistingPurchaseOrders.map(po => `${po.id} - ${po.item}`), required: true, placeholder: 'Chọn đơn mua hàng...' },
                { id: 'newPurchaseOrderItem', label: 'Tên mặt hàng mới:', type: 'text', placeholder: 'Nhập tên mặt hàng mới', optional: true },
                { id: 'newPurchaseOrderQuantity', label: 'Số lượng mới:', type: 'text', placeholder: 'Nhập số lượng mới', optional: true },
                { id: 'newPurchaseOrderUnitPrice', label: 'Đơn giá mới:', type: 'text', placeholder: 'Nhập đơn giá mới (VNĐ)', optional: true, format: 'currency' },
                { id: 'newPurchaseOrderStatus', label: 'Trạng thái mới:', type: 'select', options: ['Không thay đổi', 'Đã đặt hàng', 'Đang vận chuyển', 'Đã giao hàng', 'Đã hủy'], optional: true },
                { id: 'newPurchaseOrderExpectedDeliveryDate', label: 'Ngày giao hàng dự kiến mới:', type: 'date', optional: true },
                { id: 'newPurchaseOrderSupplier', label: 'Nhà cung cấp mới:', type: 'text', placeholder: 'Nhập nhà cung cấp mới', optional: true }
            ],
            'document_upload_request': [
                { id: 'documentTitle', label: 'Tiêu đề Tài liệu:', type: 'text', placeholder: 'Nhập tiêu đề tài liệu', required: true },
                { id: 'documentType', label: 'Loại Tài liệu:', type: 'select', options: ['Giáo trình', 'Tài liệu tham khảo', 'Quy trình'], required: true },
                { id: 'documentFiles', label: 'Tải lên tài liệu:', type: 'file', multiple: true, accept: 'image/*,application/pdf', optional: true }
            ],
            'document_access_request': [
                { id: 'documentToAccess', label: 'Tài liệu cần truy cập:', type: 'document_selector', required: true, placeholder: 'Chọn tài liệu từ danh sách...' },
                { id: 'documentPathDisplay', label: 'Đường dẫn tài liệu:', type: 'text', readOnly: true, optional: true }
            ],
            'create_tuition_record_request': [
                { id: 'tuitionStudentId', label: 'Học viên:', type: 'select', options: mockTuitionStudents.map(s => s.name), required: true, placeholder: 'Chọn học viên...' },
                { id: 'tuitionMajorId', label: 'Chuyên ngành:', type: 'select', options: mockTuitionMajors.map(m => m.name), required: true, placeholder: 'Chọn chuyên ngành...' },
                { id: 'tuitionInitialTuition', label: 'Học phí ban đầu:', type: 'text', readOnly: true, placeholder: 'Tự động điền', format: 'currency' },
                { id: 'tuitionDiscountType', label: 'Loại giảm giá:', type: 'radio-group', options: [{ value: 'amount', text: 'Số tiền' }, { value: 'percentage', text: 'Phần trăm' }], defaultValue: 'amount' },
                { id: 'tuitionDiscountValue', label: 'Giá trị giảm giá:', type: 'text', placeholder: 'Nhập giá trị giảm giá', required: true, format: 'currency-or-percentage' },
                { id: 'tuitionFinalTuition', label: 'Học phí cuối cùng:', type: 'text', readOnly: true, placeholder: 'Tự động tính', format: 'currency' },
                { id: 'tuitionPaymentDate', label: 'Ngày thanh toán:', type: 'date', optional: true },
                { id: 'tuitionPaymentMethod', label: 'Hình thức thanh toán:', type: 'select', options: mockTuitionPaymentMethods.map(pm => pm.text), optional: true, placeholder: 'Chọn hình thức...' },
                { id: 'tuitionPaymentStatus', label: 'Trạng thái thanh toán:', type: 'select', options: mockTuitionPaymentStatuses.map(ps => ps.text), required: true, placeholder: 'Chọn trạng thái...' },
                { id: 'tuitionInvoiceImageUpload', label: 'Tải ảnh hóa đơn lên:', type: 'file', accept: 'image/*', optional: true },
                { id: 'tuitionCompletionStatus', label: 'Trạng thái hoàn thành:', type: 'select', options: mockTuitionCompletionStatuses.map(cs => cs.text), required: true, placeholder: 'Chọn trạng thái...' },
                { id: 'tuitionCompletionAppointmentDate', label: 'Ngày hẹn hoàn thành:', type: 'date', optional: true }
            ],
            'edit_tuition_record_request': [
                { id: 'studentFilterForTuitionEdit', label: 'Chọn Học viên:', type: 'select', options: mockTuitionStudents.map(s => s.name), required: true, placeholder: 'Chọn học viên...' },
                { id: 'tuitionRecordToEditId', label: 'Chọn Học phí chưa hoàn thiện:', type: 'select', options: [], required: true, placeholder: 'Vui lòng chọn học viên trước...' },
                { id: 'tuitionInitialTuitionDisplay', label: 'Học phí ban đầu:', type: 'text', readOnly: true, format: 'currency', placeholder: 'Tự động điền' },
                { id: 'tuitionPaidAmountDisplay', label: 'Học phí đã thanh toán:', type: 'text', readOnly: true, format: 'currency', placeholder: 'Tự động điền' },
                { id: 'tuitionOldRemainingTuitionDisplay', label: 'Học phí còn lại (cũ):', type: 'text', readOnly: true, format: 'currency', placeholder: 'Tự động điền' },
                { id: 'tuitionPaymentAmount', label: 'Học phí thanh toán:', type: 'text', placeholder: 'Nhập số tiền thanh toán', required: true, format: 'currency' },
                { id: 'tuitionPaymentMethodUpdate', label: 'Hình thức thanh toán:', type: 'select', options: mockTuitionPaymentMethods.map(pm => pm.text), required: true, placeholder: 'Chọn hình thức...' },
                { id: 'tuitionNewRemainingTuitionDisplay', label: 'Học phí còn lại (mới):', type: 'text', readOnly: true, format: 'currency', placeholder: 'Tự động tính' },
                { id: 'tuitionPaymentStatusUpdate', label: 'Trạng thái thanh toán:', type: 'select', options: mockTuitionPaymentStatuses.map(ps => ps.text), required: true, placeholder: 'Chọn trạng thái...' },
                { id: 'tuitionInvoiceImageUploadUpdate', label: 'Tải ảnh hóa đơn lên:', type: 'file', accept: 'image/*', optional: true },
            ],
            'leave_request': [
                { id: 'leaveType', label: 'Loại nghỉ:', type: 'select', options: mockLeaveTypes, required: true, placeholder: 'Chọn loại nghỉ...' },
                { id: 'leavePeriodType', label: 'Loại thời gian nghỉ:', type: 'radio-group', options: mockLeavePeriodTypes, defaultValue: 'by_day', required: true },
                { id: 'startDate', label: 'Ngày bắt đầu:', type: 'date', required: true },
                { id: 'endDate', label: 'Ngày kết thúc:', type: 'date', required: true },
                { id: 'startTime', label: 'Giờ bắt đầu:', type: 'time', optional: true, visible: false }, // Initially hidden
                { id: 'endTime', label: 'Giờ kết thúc:', type: 'time', optional: true, visible: false }, // Initially hidden
                { id: 'reason', label: 'Lý do:', type: 'textarea', placeholder: 'Mô tả chi tiết lý do xin nghỉ', required: true },
                { id: 'supportingDocuments', label: 'Tài liệu đính kèm (nếu có):', type: 'file', multiple: true, accept: 'image/*,application/pdf', optional: true }
            ]
        };

        // Mock data for approvers
        const mockApprovers = [
            { id: 'AP001', name: 'Nguyễn Văn Giám Đốc', role: 'Giám đốc' },
            { id: 'AP002', name: 'Lê Thị Trưởng Phòng', role: 'Trưởng phòng' },
            { id: 'AP003', name: 'Phạm Văn Quản Lý', role: 'Quản lý' },
        ];

        /**
         * Populates a select element with approver options.
         * @param {HTMLElement} selectElement - The select element to populate.
         * @param {string} defaultText - The default option text.
         */
        function populateSelectWithApprovers(selectElement, defaultText) {
            selectElement.innerHTML = `<option value="">${defaultText}</option>`;
            mockApprovers.forEach(approver => {
                const option = document.createElement('option');
                option.value = approver.id;
                option.textContent = `${approver.name} (${approver.role})`;
                selectElement.appendChild(option);
            });
        }

        /**
         * Cập nhật trường trạng thái hiện tại dựa trên loại yêu cầu và người thẩm định được chọn.
         * Updates the current status field based on the selected request type and appraiser.
         */
        function updateRequestStatusDisplay() {
            const requestType = requestTypeSelect.value;
            if (requestType) {
                // For 'edit_tuition_record_request' and 'leave_request', the appraiser is not needed, so it always goes to approver
                if (requestType === 'edit_tuition_record_request' || requestType === 'leave_request') {
                    currentStatusInput.value = 'Đang chờ phê duyệt';
                    statusDescription.textContent = 'Yêu cầu sẽ được chuyển trực tiếp đến người phê duyệt.';
                    if (appraiserSelect) { // Check if appraiserSelect exists before accessing
                        appraiserSelect.value = ''; // Clear appraiser selection
                        appraiserSelect.disabled = true; // Disable appraiser select
                    }
                } else {
                    if (appraiserSelect) { // Check if appraiserSelect exists before accessing
                        appraiserSelect.disabled = false; // Enable appraiser select for other types
                        const selectedAppraiserId = appraiserSelect.value;
                        if (selectedAppraiserId) {
                            currentStatusInput.value = 'Đang chờ thẩm định';
                            statusDescription.textContent = 'Yêu cầu sẽ được thẩm định trước khi chuyển sang phê duyệt.';
                        } else {
                            currentStatusInput.value = 'Đang chờ phê duyệt';
                            statusDescription.textContent = 'Yêu cầu sẽ được chuyển trực tiếp đến người phê duyệt.';
                        }
                    }
                }
            } else {
                currentStatusInput.value = 'Chọn loại yêu cầu để xem trạng thái ban đầu';
                statusDescription.textContent = 'Trạng thái này sẽ thay đổi khi yêu cầu được xử lý trong luồng công việc.';
                if (appraiserSelect) { // Check if appraiserSelect exists before accessing
                    appraiserSelect.disabled = false; // Ensure appraiser is enabled when no request type is selected
                }
            }
            // Handle visibility of requestDescription based on requestType
            if (requestType === 'leave_request') {
                if (requestDescriptionGroup) requestDescriptionGroup.style.display = 'none';
                if (requestDescriptionInput) requestDescriptionInput.required = false;
            } else {
                if (requestDescriptionGroup) requestDescriptionGroup.style.display = 'block';
                if (requestDescriptionInput) requestDescriptionInput.required = true;
            }
        }

        // Lắng nghe sự kiện thay đổi loại yêu cầu để render các trường động và cập nhật trạng thái.
        // Listens for changes in request type to render dynamic fields and update status.
        requestTypeSelect.addEventListener('change', (event) => {
            renderDynamicFields(event.target.value);
            updateRequestStatusDisplay();
        });

        // Lắng nghe sự kiện thay đổi người thẩm định để cập nhật trạng thái.
        // Listens for changes in the appraiser to update the status.
        if (appraiserSelect) { // Check if appraiserSelect exists before adding listener
            appraiserSelect.addEventListener('change', updateRequestStatusDisplay);
        }

        /**
         * Định dạng một số thành chuỗi tiền tệ với dấu phân cách hàng nghìn.
         * Formats a number into a currency string with thousands separators.
         * @param {string} value - Giá trị số (có thể là chuỗi). The numeric value (can be a string).
         * @returns {string} - Chuỗi tiền tệ đã định dạng. The formatted currency string.
         */
        function formatCurrency(value) {
            if (value === null || value === undefined || isNaN(value)) {
                return '';
            }
            return parseFloat(value).toLocaleString('vi-VN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        /**
         * Loại bỏ định dạng khỏi chuỗi tiền tệ để lấy số nguyên.
         * Removes formatting from a currency string to get the raw number.
         * @param {string} value - Chuỗi tiền tệ đã định dạng. The formatted currency string.
         * @returns {number} - Số nguyên không có định dạng. The unformatted number.
         */
        function unformatCurrency(currencyString) {
            if (!currencyString) {
                return 0;
            }
            const cleanedString = String(currencyString).replace(/[^0-9]/g, '');
            return parseFloat(cleanedString);
        }

        /**
         * Render các trường biểu mẫu động dựa trên loại yêu cầu.
         * Renders dynamic form fields based on the selected request type.
         * @param {string} type - Loại yêu cầu được chọn. The selected request type.
         */
        function renderDynamicFields(type) {
            dynamicFormFieldsDiv.innerHTML = '';
            const fields = requestFields[type];

            if (fields) {
                fields.forEach(field => {
                    const formGroup = document.createElement('div');
                    formGroup.classList.add('form-group');

                    const label = document.createElement('label');
                    label.setAttribute('for', field.id);
                    label.textContent = field.label;
                    formGroup.appendChild(label);

                    let inputElement = null;

                    if (field.type === 'select') {
                        inputElement = document.createElement('select');
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = field.placeholder || `Chọn ${field.label.toLowerCase().replace(':', '')}`;
                        inputElement.appendChild(defaultOption);
                        if (field.options) {
                            field.options.forEach(optionText => {
                                const option = document.createElement('option');
                                option.value = optionText;
                                option.textContent = optionText;
                                inputElement.appendChild(option);
                            });
                        }
                    } else if (field.type === 'textarea') {
                        inputElement = document.createElement('textarea');
                        inputElement.rows = 3;
                    } else if (field.type === 'file') {
                        inputElement = document.createElement('input');
                        inputElement.type = 'file';
                        if (field.multiple) {
                            inputElement.multiple = true;
                        }
                        if (field.accept) {
                            inputElement.accept = field.accept;
                        }

                        // Create image preview container and elements if it's an invoice image upload
                        if (field.id === 'tuitionInvoiceImageUpload' || field.id === 'tuitionInvoiceImageUploadUpdate') {
                            const previewContainer = document.createElement('div');
                            previewContainer.id = `${field.id.replace('Upload', '')}PreviewContainer`;
                            previewContainer.classList.add('invoice-image-preview-container');
                            previewContainer.style.display = 'none'; // Hidden by default

                            const imagePreview = document.createElement('img');
                            imagePreview.id = `${field.id.replace('Upload', '')}Preview`;
                            imagePreview.classList.add('invoice-image-preview');
                            imagePreview.alt = 'Ảnh hóa đơn';
                            previewContainer.appendChild(imagePreview);

                            const clearButton = document.createElement('button');
                            clearButton.type = 'button';
                            clearButton.id = `${field.id.replace('Upload', '')}ClearInvoiceImageBtn`;
                            clearButton.classList.add('clear-image-btn');
                            clearButton.textContent = 'Xóa ảnh';
                            previewContainer.appendChild(clearButton);

                            formGroup.appendChild(previewContainer);
                        }

                        const fileListDisplay = document.createElement('div');
                        fileListDisplay.id = `${field.id}Display`;
                        fileListDisplay.classList.add('mt-2', 'text-sm', 'text-gray-600');
                        formGroup.appendChild(fileListDisplay);

                        inputElement.addEventListener('change', () => {
                            fileListDisplay.innerHTML = '';
                            if (inputElement.files.length > 0) {
                                let fileNames = [];
                                for (let i = 0; i < inputElement.files.length; i++) {
                                    fileNames.push(inputElement.files[i].name);
                                }
                                fileListDisplay.textContent = `Đã chọn: ${fileNames.join(', ')}`;
                            } else {
                                fileListDisplay.textContent = 'Chưa có tệp nào được chọn.';
                            }
                        });
                    } else if (field.type === 'checkbox-group') {
                        const checkboxGroupDiv = document.createElement('div');
                        checkboxGroupDiv.classList.add('checkbox-group');
                        checkboxGroupDiv.id = field.id;

                        field.options.forEach(optionText => {
                            const checkboxLabel = document.createElement('label');
                            const checkboxInput = document.createElement('input');
                            checkboxInput.type = 'checkbox';
                            checkboxInput.name = field.id;
                            checkboxInput.value = optionText;
                            checkboxLabel.appendChild(checkboxInput);
                            checkboxLabel.appendChild(document.createTextNode(optionText));
                            checkboxGroupDiv.appendChild(checkboxLabel);
                        });
                        formGroup.appendChild(checkboxGroupDiv);
                    } else if (field.type === 'radio-group') {
                        const radioGroupDiv = document.createElement('div');
                        radioGroupDiv.classList.add('radio-group');
                        radioGroupDiv.id = field.id;

                        field.options.forEach(option => {
                            const radioLabel = document.createElement('label');
                            const radioInput = document.createElement('input');
                            radioInput.type = 'radio';
                            radioInput.name = field.id;
                            radioInput.value = option.value;
                            if (field.defaultValue === option.value) {
                                radioInput.checked = true;
                            }
                            radioLabel.appendChild(radioInput);
                            radioLabel.appendChild(document.createTextNode(option.text));
                            radioGroupDiv.appendChild(radioLabel);
                        });
                        formGroup.appendChild(radioGroupDiv);
                    }
                    else if (field.type === 'document_selector') {
                        const inputGroupDiv = document.createElement('div');
                        inputGroupDiv.classList.add('flex', 'gap-2');

                        inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        inputElement.placeholder = field.placeholder || '';
                        inputElement.readOnly = true;
                        inputElement.classList.add('read-only-field', 'flex-grow');
                        inputElement.id = field.id;
                        inputElement.name = field.id;
                        inputElement.required = (field.required !== undefined) ? field.required : (!field.readOnly && !field.optional);

                        const selectButton = document.createElement('button');
                        selectButton.type = 'button';
                        selectButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'py-2', 'px-4', 'rounded-md', 'transition', 'duration-300', 'flex-shrink-0');
                        selectButton.innerHTML = '<i class="fas fa-folder-open mr-2"></i>Chọn Tài liệu';
                        selectButton.addEventListener('click', () => {
                            showDocumentModal();
                        });

                        inputGroupDiv.appendChild(inputElement);
                        inputGroupDiv.appendChild(selectButton);
                        formGroup.appendChild(inputGroupDiv);

                        const hiddenDocIdInput = document.createElement('input');
                        hiddenDocIdInput.type = 'hidden';
                        hiddenDocIdInput.id = `${field.id}Id`;
                        hiddenDocIdInput.name = `${field.id}Id`;
                        formGroup.appendChild(hiddenDocIdInput);

                        inputElement = null; // Set to null as it's a composite element
                    }
                    else {
                        inputElement = document.createElement('input');
                        inputElement.type = field.type;
                        if (field.placeholder) {
                            inputElement.placeholder = field.placeholder;
                        }
                        if (field.readOnly) {
                            inputElement.readOnly = true;
                            inputElement.classList.add('read-only-field');
                            if (field.value) {
                                inputElement.value = field.value;
                            }
                        }
                        // Set the disabled property if specified in the field configuration
                        if (field.disabled) {
                            inputElement.disabled = true;
                        }
                        inputElement.id = field.id;
                        inputElement.name = field.id;
                        // Set required based on field config, will be overridden for tuition payment fields
                        inputElement.required = (field.required !== undefined) ? field.required : (!field.readOnly && !field.optional);

                        if (field.format === 'currency') {
                            inputElement.addEventListener('input', (e) => {
                                const unformattedValue = unformatCurrency(e.target.value);
                                e.target.value = formatCurrency(unformattedValue);
                            });
                            inputElement.addEventListener('blur', (e) => {
                                const unformattedValue = unformatCurrency(e.target.value);
                                e.target.value = formatCurrency(unformattedValue);
                            });
                        } else if (field.format === 'currency-or-percentage') {
                            inputElement.addEventListener('input', (e) => {
                                const discountTypeRadio = document.querySelector(`input[name="${field.id.replace('Value', 'Type')}"]:checked`);
                                const discountType = discountTypeRadio ? discountTypeRadio.value : 'amount'; // Default to 'amount'
                                handleCurrencyOrPercentageInputFormatting(e, discountType);
                            });
                            inputElement.addEventListener('blur', (e) => {
                                const discountTypeRadio = document.querySelector(`input[name="${field.id.replace('Value', 'Type')}"]:checked`);
                                const discountType = discountTypeRadio ? discountTypeRadio.value : 'amount'; // Default to 'amount'
                                handleCurrencyOrPercentageInputFormatting(e, discountType);
                            });
                        }
                    }

                    if (inputElement) {
                        formGroup.appendChild(inputElement);
                        if (field.format === 'currency') {
                            const clarificationSpan = document.createElement('p');
                            clarificationSpan.classList.add('text-sm', 'text-gray-500', 'mt-1');
                            clarificationSpan.textContent = 'Số sẽ tự động được định dạng (ví dụ: 1.000.000). Bạn có thể nhập số lớn hơn.';
                            formGroup.appendChild(clarificationSpan);
                        } else if (field.format === 'currency-or-percentage') {
                             const clarificationSpan = document.createElement('p');
                            clarificationSpan.classList.add('text-sm', 'text-gray-500', 'mt-1');
                            clarificationSpan.textContent = 'Nhập giá trị số. Sẽ được định dạng theo loại giảm giá đã chọn.';
                            formGroup.appendChild(clarificationSpan);
                        }
                    }

                    // Set initial visibility for leave request fields
                    if (type === 'leave_request' && (field.id === 'startTime' || field.id === 'endTime')) {
                        formGroup.style.display = field.visible ? 'block' : 'none';
                    }

                    dynamicFormFieldsDiv.appendChild(formGroup);

                    // Specific logic for dynamic fields
                    if (field.id === 'className' && type === 'class_request') {
                        const classMajorInput = document.getElementById('classMajor');
                        const classNameInput = document.getElementById('className');

                        const updateClassName = () => {
                            const major = classMajorInput ? classMajorInput.value : '';
                            const uniqueId = Math.random().toString(36).substring(2, 8).toUpperCase();
                            if (major) {
                                classNameInput.value = `${major} - Lớp ${uniqueId}`;
                            } else {
                                classNameInput.value = '';
                            }
                        };

                        if (classMajorInput) {
                            classMajorInput.addEventListener('change', updateClassName);
                        }
                        updateClassName();
                    }

                    if ((field.id === 'studentConsultant' && type === 'student_request') || (field.id === 'newStudentConsultant' && type === 'edit_student_info_request')) {
                        const currentInput = document.getElementById(field.id);
                        if (currentInput) { // Ensure currentInput exists
                            currentInput.addEventListener('input', (e) => {
                                const enteredAccount = e.target.value.toLowerCase();
                                const foundConsultant = mockConsultantAccounts.find(c => c.account === enteredAccount);
                                if (foundConsultant) {
                                    e.target.dataset.accountName = foundConsultant.account;
                                    e.target.value = foundConsultant.displayName;
                                    e.target.readOnly = true;
                                    e.target.classList.add('read-only-field');
                                } else {
                                    delete e.target.dataset.accountName;
                                    e.target.readOnly = false;
                                    e.target.classList.remove('read-only-field');
                                }
                            });

                            currentInput.addEventListener('focus', (e) => {
                                if (e.target.dataset.accountName) {
                                    e.target.value = e.target.dataset.accountName;
                                    e.target.readOnly = false;
                                    e.target.classList.remove('read-only-field');
                                }
                            });

                            currentInput.addEventListener('blur', (e) => {
                                const enteredAccount = e.target.value.toLowerCase();
                                const foundConsultant = mockConsultantAccounts.find(c => c.account === enteredAccount);
                                if (foundConsultant) {
                                    e.target.value = foundConsultant.displayName;
                                    e.target.dataset.accountName = foundConsultant.account;
                                    e.target.readOnly = true;
                                    e.target.classList.add('read-only-field');
                                } else {
                                    e.target.value = '';
                                    delete e.target.dataset.accountName;
                                    e.target.readOnly = false;
                                    e.target.classList.remove('read-only-field');
                                    showCustomMessage('Tên tài khoản nhân viên tư vấn không hợp lệ. Vui lòng nhập lại.');
                                }
                            });
                        }
                    }

                    // Tuition-specific dynamic field logic
                    if (type === 'create_tuition_record_request' || type === 'edit_tuition_record_request') {
                        const studentSelectElement = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionStudentId' : 'studentFilterForTuitionEdit'); // For edit, this is the filter
                        const majorSelectElement = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionMajorId' : 'newTuitionMajorId');
                        const initialTuitionInput = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionInitialTuition' : 'tuitionInitialTuitionDisplay');
                        const discountTypeRadios = document.querySelectorAll(`input[name="${type === 'create_tuition_record_request' ? 'tuitionDiscountType' : 'newTuitionDiscountType'}"]`);
                        const discountValueInput = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionDiscountValue' : 'newTuitionDiscountValue'); // This is not used in edit_tuition_record_request anymore
                        const finalTuitionInput = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionFinalTuition' : 'tuitionNewRemainingTuitionDisplay'); // This is new remaining in edit
                        const paymentDateInput = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionPaymentDate' : 'newTuitionPaymentDate');
                        const paymentMethodSelect = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionPaymentMethod' : 'tuitionPaymentMethodUpdate');
                        const paymentStatusSelect = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionPaymentStatus' : 'tuitionPaymentStatusUpdate');
                        const invoiceImageUpload = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionInvoiceImageUpload' : 'tuitionInvoiceImageUploadUpdate');
                        const invoiceImagePreview = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionInvoiceImagePreview' : 'tuitionInvoiceImagePreviewUpdate');
                        const invoiceImagePreviewContainer = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionInvoiceImagePreviewContainer' : 'tuitionInvoiceImagePreviewUpdateContainer');
                        const clearInvoiceImageBtn = document.getElementById(type === 'create_tuition_record_request' ? 'tuitionClearInvoiceImageBtn' : 'tuitionInvoiceImageUploadUpdateClearInvoiceImageBtn');

                        // New fields for edit_tuition_record_request
                        const tuitionPaymentAmountInput = document.getElementById('tuitionPaymentAmount');
                        const tuitionPaidAmountDisplay = document.getElementById('tuitionPaidAmountDisplay');
                        const tuitionOldRemainingTuitionDisplay = document.getElementById('tuitionOldRemainingTuitionDisplay');


                        // Define the toggle function for payment fields (for create_tuition_record_request)
                        const togglePaymentFields = (status) => {
                            const isPaid = status === mockTuitionPaymentStatuses.find(ps => ps.value === 'paid')?.text;

                            if (paymentDateInput) {
                                paymentDateInput.disabled = !isPaid;
                                paymentDateInput.required = isPaid;
                                if (!isPaid) paymentDateInput.value = ''; // Clear if disabled
                            }
                            if (paymentMethodSelect) {
                                paymentMethodSelect.disabled = !isPaid;
                                paymentMethodSelect.required = isPaid;
                                if (!isPaid) paymentMethodSelect.value = ''; // Reset select
                            }
                            if (invoiceImageUpload) {
                                invoiceImageUpload.disabled = !isPaid;
                                invoiceImageUpload.required = isPaid;
                                if (!isPaid) {
                                    invoiceImageUpload.value = ''; // Clear file input
                                    currentInvoiceBase64 = ''; // Clear stored Base64
                                    if (invoiceImagePreview) invoiceImagePreview.src = '';
                                    if (invoiceImagePreviewContainer) invoiceImagePreviewContainer.style.display = 'none';
                                }
                            }
                            if (clearInvoiceImageBtn) {
                                clearInvoiceImageBtn.style.display = isPaid && currentInvoiceBase64 ? 'block' : 'none';
                            }
                        };


                        // Re-attach event listeners for tuition fields if they exist
                        if (type === 'create_tuition_record_request' && majorSelectElement) {
                            majorSelectElement.onchange = () => {
                                const selectedMajorName = majorSelectElement.value;
                                const selectedMajor = mockTuitionMajors.find(m => m.name === selectedMajorName);
                                if (initialTuitionInput) initialTuitionInput.value = selectedMajor ? formatCurrency(selectedMajor.baseTuition) : '';
                                calculateFinalTuitionForRequestForm(initialTuitionInput, discountTypeRadios, discountValueInput, finalTuitionInput);
                            };
                        }

                        if (type === 'create_tuition_record_request' && discountTypeRadios) {
                            discountTypeRadios.forEach(radio => {
                                radio.onchange = () => {
                                    calculateFinalTuitionForRequestForm(initialTuitionInput, discountTypeRadios, discountValueInput, finalTuitionInput);
                                };
                            });
                        }

                        if (type === 'create_tuition_record_request' && discountValueInput) {
                            discountValueInput.oninput = (e) => {
                                const discountTypeRadio = document.querySelector(`input[name="${field.id.replace('Value', 'Type')}"]:checked`);
                                const discountType = discountTypeRadio ? discountTypeRadio.value : 'amount'; // Default to 'amount'
                                handleCurrencyOrPercentageInputFormatting(e, discountType);
                                calculateFinalTuitionForRequestForm(initialTuitionInput, discountTypeRadios, discountValueInput, finalTuitionInput);
                            };
                            discountValueInput.onblur = (e) => {
                                const discountTypeRadio = document.querySelector(`input[name="${field.id.replace('Value', 'Type')}"]:checked`);
                                const discountType = discountTypeRadio ? discountTypeRadio.value : 'amount'; // Default to 'amount'
                                handleCurrencyOrPercentageInputFormatting(e, discountType);
                                calculateFinalTuitionForRequestForm(initialTuitionInput, discountTypeRadios, discountValueInput, finalTuitionInput);
                            };
                        }

                        // Event listener for payment status change (for create_tuition_record_request)
                        if (type === 'create_tuition_record_request' && paymentStatusSelect) {
                            paymentStatusSelect.addEventListener('change', (e) => {
                                togglePaymentFields(e.target.value);
                            });
                        }

                        // Invoice Image Handling for request form (for create_tuition_record_request)
                        if (type === 'create_tuition_record_request' && invoiceImageUpload) {
                            invoiceImageUpload.onchange = (event) => {
                                const file = event.target.files[0];
                                if (file) {
                                    const reader = new FileReader();
                                    reader.onload = (e) => {
                                        currentInvoiceBase64 = e.target.result;
                                        if (invoiceImagePreview) invoiceImagePreview.src = currentInvoiceBase64;
                                        if (invoiceImagePreviewContainer) invoiceImagePreviewContainer.style.display = 'flex';
                                        if (clearInvoiceImageBtn) clearInvoiceImageBtn.style.display = 'block';
                                    };
                                    reader.onerror = () => {
                                        showCustomMessage('Không thể đọc tệp hình ảnh.');
                                        currentInvoiceBase64 = '';
                                        if (invoiceImagePreview) invoiceImagePreview.src = '';
                                        if (invoiceImagePreviewContainer) invoiceImagePreviewContainer.style.display = 'none';
                                        if (clearInvoiceImageBtn) clearInvoiceImageBtn.style.display = 'none';
                                    };
                                    reader.readAsDataURL(file);
                                } else {
                                    currentInvoiceBase64 = '';
                                    if (invoiceImagePreview) invoiceImagePreview.src = '';
                                    if (invoiceImagePreviewContainer) invoiceImagePreviewContainer.style.display = 'none';
                                    if (clearInvoiceImageBtn) clearInvoiceImageBtn.style.display = 'none';
                                }
                            };
                        }

                        if (type === 'create_tuition_record_request' && clearInvoiceImageBtn) {
                            clearInvoiceImageBtn.onclick = () => {
                                currentInvoiceBase64 = '';
                                if (invoiceImageUpload) invoiceImageUpload.value = '';
                                if (invoiceImagePreview) invoiceImagePreview.src = '';
                                if (invoiceImagePreviewContainer) invoiceImagePreviewContainer.style.display = 'none';
                                if (clearInvoiceImageBtn) clearInvoiceImageBtn.style.display = 'none';
                            };
                        }

                        // Initial state for payment fields when dynamic fields are rendered (for create_tuition_record_request)
                        if (type === 'create_tuition_record_request') {
                            togglePaymentFields(paymentStatusSelect ? paymentStatusSelect.value : '');
                        }

                        // Logic specific to edit_tuition_record_request for payment completion
                        if (type === 'edit_tuition_record_request') {
                            // Calculate new remaining tuition
                            const calculateNewRemainingTuition = () => {
                                const oldRemaining = tuitionOldRemainingTuitionDisplay ? unformatCurrency(tuitionOldRemainingTuitionDisplay.value) : 0;
                                const paymentAmount = tuitionPaymentAmountInput ? unformatCurrency(tuitionPaymentAmountInput.value) : 0;
                                const newRemaining = oldRemaining - paymentAmount;
                                if (tuitionNewRemainingTuitionDisplay) tuitionNewRemainingTuitionDisplay.value = formatCurrency(Math.max(0, newRemaining));

                                // Update payment status based on new remaining
                                if (tuitionPaymentStatusUpdate) {
                                    if (newRemaining <= 0) {
                                        tuitionPaymentStatusUpdate.value = mockTuitionPaymentStatuses.find(ps => ps.value === 'paid')?.text;
                                    } else if (paymentAmount > 0) {
                                        tuitionPaymentStatusUpdate.value = mockTuitionPaymentStatuses.find(ps => ps.value === 'partially_paid')?.text;
                                    } else {
                                        // If payment amount is 0, keep original status or set to unpaid if it was.
                                        // This case needs careful handling based on initial status.
                                        // For simplicity, if payment is 0, assume no change to status unless it was 'paid'
                                        const selectedTuitionId = parseInt(document.getElementById('tuitionRecordToEditId').value.split(' - ')[0].replace('Mã: ', ''));
                                        const selectedTuition = allTuitionData.find(t => t.id === selectedTuitionId);
                                        if (selectedTuition) {
                                            tuitionPaymentStatusUpdate.value = allPaymentStatuses.find(ps => ps.value === selectedTuition.paymentStatus)?.text;
                                        }
                                    }
                                }
                            };

                            if (tuitionPaymentAmountInput) {
                                tuitionPaymentAmountInput.addEventListener('input', calculateNewRemainingTuition);
                                tuitionPaymentAmountInput.addEventListener('blur', calculateNewRemainingTuition);
                            }

                            // Invoice Image Handling for edit form
                            if (invoiceImageUpload) {
                                invoiceImageUpload.onchange = (event) => {
                                    const file = event.target.files[0];
                                    if (file) {
                                        const reader = new FileReader();
                                        reader.onload = (e) => {
                                            currentInvoiceBase64 = e.target.result;
                                            if (invoiceImagePreview) invoiceImagePreview.src = currentInvoiceBase64;
                                            if (invoiceImagePreviewContainer) invoiceImagePreviewContainer.style.display = 'flex';
                                            if (clearInvoiceImageBtn) clearInvoiceImageBtn.style.display = 'block';
                                        };
                                        reader.onerror = () => {
                                            showCustomMessage('Không thể đọc tệp hình ảnh.');
                                            currentInvoiceBase64 = '';
                                            if (invoiceImagePreview) invoiceImagePreview.src = '';
                                            if (invoiceImagePreviewContainer) invoiceImagePreviewContainer.style.display = 'none';
                                            if (clearInvoiceImageBtn) clearInvoiceImageBtn.style.display = 'none';
                                        };
                                        reader.readAsDataURL(file);
                                    } else {
                                        currentInvoiceBase64 = '';
                                        if (invoiceImagePreview) invoiceImagePreview.src = '';
                                        if (invoiceImagePreviewContainer) invoiceImagePreviewContainer.style.display = 'none';
                                        if (clearInvoiceImageBtn) clearInvoiceImageBtn.style.display = 'none';
                                    }
                                };
                            }

                            if (clearInvoiceImageBtn) {
                                clearInvoiceImageBtn.onclick = () => {
                                    currentInvoiceBase64 = '';
                                    if (invoiceImageUpload) invoiceImageUpload.value = '';
                                    if (invoiceImagePreview) invoiceImagePreview.src = '';
                                    if (invoiceImagePreviewContainer) invoiceImagePreviewContainer.style.display = 'none';
                                    if (clearInvoiceImageBtn) clearInvoiceImageBtn.style.display = 'none';
                                };
                            }
                        }
                    } else if (type === 'leave_request') {
                        const leavePeriodTypeRadios = document.querySelectorAll('input[name="leavePeriodType"]');
                        const startDateInput = document.getElementById('startDate');
                        const endDateInput = document.getElementById('endDate');
                        const startTimeInput = document.getElementById('startTime');
                        const endTimeInput = document.getElementById('endTime');

                        const toggleLeaveTimeFields = (periodType) => {
                            const showTimeFields = periodType === 'by_hour';
                            const startTimeGroup = startTimeInput ? startTimeInput.closest('.form-group') : null;
                            const endTimeGroup = endTimeInput ? endTimeInput.closest('.form-group') : null;

                            if (startTimeGroup) {
                                startTimeGroup.style.display = showTimeFields ? 'block' : 'none';
                                startTimeInput.required = showTimeFields;
                                startTimeInput.disabled = !showTimeFields;
                                if (!showTimeFields) startTimeInput.value = '';
                            }
                            if (endTimeGroup) {
                                endTimeGroup.style.display = showTimeFields ? 'block' : 'none';
                                endTimeInput.required = showTimeFields;
                                endTimeInput.disabled = !showTimeFields;
                                if (!showTimeFields) endTimeInput.value = '';
                            }
                        };

                        leavePeriodTypeRadios.forEach(radio => {
                            radio.addEventListener('change', (e) => {
                                toggleLeaveTimeFields(e.target.value);
                            });
                        });

                        // Initial toggle based on default value
                        const initialLeavePeriodType = document.querySelector('input[name="leavePeriodType"]:checked')?.value || 'by_day';
                        toggleLeaveTimeFields(initialLeavePeriodType);

                        // Add validation for hourly leave dates
                        const validateHourlyLeaveDates = () => {
                            const currentPeriodType = document.querySelector('input[name="leavePeriodType"]:checked')?.value;
                            if (currentPeriodType === 'by_hour') {
                                if (startDateInput && endDateInput && startDateInput.value !== endDateInput.value) {
                                    showCustomMessage('Đối với nghỉ theo giờ, Ngày bắt đầu và Ngày kết thúc phải là cùng một ngày.');
                                    endDateInput.value = startDateInput.value; // Auto-correct
                                }
                            }
                        };

                        if (startDateInput) startDateInput.addEventListener('change', validateHourlyLeaveDates);
                        if (endDateInput) endDateInput.addEventListener('change', validateHourlyLeaveDates);
                    }
                });

                // Attach event listeners for "edit" type dropdowns after dynamic fields are rendered
                // Gắn trình lắng nghe sự kiện cho các dropdown loại "chỉnh sửa" sau khi các trường động được render
                if (type === 'edit_class_request') {
                    const classToEditSelect = document.getElementById('classToEditId');
                    if (classToEditSelect) {
                        classToEditSelect.addEventListener('change', handleClassToEditSelection);
                    }
                }

                if (type === 'change_staff_info_request') {
                    const staffToEditSelect = document.getElementById('staffToEditId');
                    if (staffToEditSelect) {
                        staffToEditSelect.addEventListener('change', handleStaffToEditSelection);
                    }
                }

                if (type === 'edit_student_info_request') {
                    const studentToEditSelect = document.getElementById('studentToEditId');
                    if (studentToEditSelect) {
                        studentToEditSelect.addEventListener('change', handleStudentToEditSelection);
                    }
                }

                if (type === 'edit_major_request') {
                    const majorToEditSelect = document.getElementById('majorToEdit');
                    if (majorToEditSelect) {
                        majorToEditSelect.addEventListener('change', handleMajorToEditSelection);
                    }
                }

                if (type === 'edit_purchase_order_request') {
                    const purchaseOrderToEditSelect = document.getElementById('purchaseOrderToEditId');
                    if (purchaseOrderToEditSelect) {
                        purchaseOrderToEditSelect.addEventListener('change', handlePurchaseOrderToEditSelection);
                    }
                }

                if (type === 'edit_tuition_record_request') {
                    const studentFilterForTuitionEdit = document.getElementById('studentFilterForTuitionEdit');
                    const tuitionRecordToEditSelect = document.getElementById('tuitionRecordToEditId');

                    if (studentFilterForTuitionEdit) {
                        // Populate student filter dropdown
                        populateDropdown(studentFilterForTuitionEdit, mockTuitionStudents, 'Chọn học viên để lọc...');
                        studentFilterForTuitionEdit.addEventListener('change', () => {
                            const selectedStudentName = studentFilterForTuitionEdit.value;
                            populateTuitionRecordsForStudent(selectedStudentName);
                            clearTuitionEditFields(); // Clear fields when student filter changes
                        });
                    }

                    if (tuitionRecordToEditSelect) {
                        // Initially disable and clear tuition record dropdown
                        tuitionRecordToEditSelect.disabled = true;
                        tuitionRecordToEditSelect.innerHTML = '<option value="">Vui lòng chọn học viên trước...</option>';
                        tuitionRecordToEditSelect.addEventListener('change', handleTuitionRecordToEditSelection);
                    }
                }
            }
        }

        /**
         * Populates a dropdown element with options.
         * @param {HTMLElement} selectElement - The select element to populate.
         * @param {Array<Object>} data - An array of objects with 'id' and 'name' properties.
         * @param {string} defaultText - The default option text.
         */
        function populateDropdown(selectElement, data, defaultText) {
            selectElement.innerHTML = `<option value="">${defaultText}</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name; // Use name for display and value
                option.textContent = item.name;
                selectElement.appendChild(option);
            });
        }

        /**
         * Populates the 'Chọn bản ghi học phí' dropdown based on the selected student.
         * @param {string} studentName - The name of the selected student.
         */
        function populateTuitionRecordsForStudent(studentName) {
            const tuitionRecordToEditSelect = document.getElementById('tuitionRecordToEditId');
            if (!tuitionRecordToEditSelect) return;

            const student = allStudents.find(s => s.name === studentName);
            let filteredTuitionRecords = [];

            if (student) {
                // Filter for 'partially_paid' or 'unpaid' records
                filteredTuitionRecords = allTuitionData.filter(t =>
                    t.studentId === student.id &&
                    (t.paymentStatus === 'partially_paid' || t.paymentStatus === 'unpaid')
                );
            }

            const optionsData = filteredTuitionRecords.map(t => ({
                id: t.id,
                name: `Mã: ${t.id} - ${allMajors.find(m => m.id === t.majorId)?.name || 'N/A'} - Còn lại: ${formatCurrency((t.initialTuition - t.discountValue) - t.paidAmount)} VNĐ`
            }));

            populateDropdown(tuitionRecordToEditSelect, optionsData, 'Chọn học phí chưa hoàn thiện...');
            tuitionRecordToEditSelect.disabled = !student; // Enable only if a student is selected

            // Auto-select if only one option
            if (filteredTuitionRecords.length === 1) {
                tuitionRecordToEditSelect.value = optionsData[0].name; // Set value to the name string
                tuitionRecordToEditSelect.dispatchEvent(new Event('change')); // Trigger change to populate fields
            }
        }


        /**
         * Clears all dynamic fields related to tuition editing.
         */
        function clearTuitionEditFields() {
            const fieldsToClear = [
                'tuitionInitialTuitionDisplay', 'tuitionPaidAmountDisplay',
                'tuitionOldRemainingTuitionDisplay', 'tuitionPaymentAmount', 'tuitionNewRemainingTuitionDisplay'
            ];

            fieldsToClear.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = '';
                }
            });

            const paymentMethodSelect = document.getElementById('tuitionPaymentMethodUpdate');
            if (paymentMethodSelect) paymentMethodSelect.value = ''; // Reset to default placeholder

            const paymentStatusSelect = document.getElementById('tuitionPaymentStatusUpdate');
            if (paymentStatusSelect) paymentStatusSelect.value = ''; // Reset to default placeholder

            const invoiceImageUpload = document.getElementById('tuitionInvoiceImageUploadUpdate');
            const invoiceImagePreview = document.getElementById('tuitionInvoiceImagePreviewUpdate');
            const invoiceImagePreviewContainer = document.getElementById('tuitionInvoiceImagePreviewUpdateContainer');
            const clearInvoiceImageBtn = document.getElementById('tuitionInvoiceImageUploadUpdateClearInvoiceImageBtn');

            if (invoiceImageUpload) invoiceImageUpload.value = '';
            if (invoiceImagePreview) invoiceImagePreview.src = '';
            if (invoiceImagePreviewContainer) invoiceImagePreviewContainer.style.display = 'none';
            if (clearInvoiceImageBtn) clearInvoiceImageBtn.style.display = 'none';
            currentInvoiceBase64 = ''; // Clear stored Base64
        }


        /**
         * Calculates final tuition for the request form, specifically for tuition-related requests.
         * @param {HTMLElement} initialTuitionInput - Input element for initial tuition.
         * @param {NodeList} discountTypeRadios - Radio buttons for discount type.
         * @param {HTMLElement} discountValueInput - Input element for discount value.
         * @param {HTMLElement} finalTuitionInput - Input element for final tuition.
         */
        function calculateFinalTuitionForRequestForm(initialTuitionInput, discountTypeRadios, discountValueInput, finalTuitionInput) {
            const initial = initialTuitionInput ? unformatCurrency(initialTuitionInput.value) : 0;
            // Ensure discountTypeRadios is an iterable and contains elements
            const checkedRadio = discountTypeRadios && Array.isArray(Array.from(discountTypeRadios)) ?
                                 Array.from(discountTypeRadios).find(radio => radio.checked) : null;

            const discountType = checkedRadio ? checkedRadio.value : 'amount'; // Default to 'amount' if no radio is checked
            let discountValue = parseFloat(String(discountValueInput ? discountValueInput.value : '').replace(/[^0-9.]/g, '')) || 0;

            let finalTuition = initial;

            if (discountType === 'amount') {
                finalTuition = initial - discountValue;
            } else if (discountType === 'percentage') {
                if (discountValue > 100) discountValue = 100;
                finalTuition = initial * (1 - discountValue / 100);
            }
            if (finalTuitionInput) finalTuitionInput.value = formatCurrency(Math.max(0, finalTuition));
        }

        /**
         * Handles currency or percentage input formatting for the request form.
         * @param {Event} event - The input event.
         * @param {string} discountType - The current discount type ('amount' or 'percentage').
         */
        function handleCurrencyOrPercentageInputFormatting(event, discountType) {
            const input = event.target;
            let value = input.value;

            if (discountType === 'amount') {
                input.value = formatCurrency(unformatCurrency(value));
            } else if (discountType === 'percentage') {
                value = value.replace(/[^0-9.]/g, '');
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }
                if (value.startsWith('.')) value = '0' + value;
                if (value.endsWith('.')) { /* do nothing */ }
                else if (value !== '') {
                    value = parseFloat(value);
                    if (value > 100) value = 100;
                    input.value = value + '%';
                } else {
                    input.value = '';
                }
            }
        }


        /**
         * Xử lý việc chọn một lớp học để chỉnh sửa và điền dữ liệu vào các trường.
         * Handles selecting a class for editing and populating the fields.
         */
        function handleClassToEditSelection() {
            const classToEditSelect = document.getElementById('classToEditId');
            const selectedClassId = classToEditSelect.value.split(' - ')[0];

            const selectedClass = mockExistingClasses.find(cls => cls.id === selectedClassId);

            // Get all editable fields for class edit
            const newClassTeacher = document.getElementById('newClassTeacher');
            const newClassTeachingAssistant = document.getElementById('newClassTeachingAssistant');
            const newClassRoom = document.getElementById('newClassRoom');
            const newClassStartDate = document.getElementById('newClassStartDate');
            const newClassEndDate = document.getElementById('newClassEndDate');
            const newClassStatus = document.getElementById('newClassStatus');
            const newClassMaxStudents = document.getElementById('newClassMaxStudents');
            const newClassScheduleTimeStart = document.getElementById('newClassScheduleTimeStart');
            const newClassScheduleTimeEnd = document.getElementById('newClassScheduleTimeEnd');
            const scheduleDaysCheckboxes = document.querySelectorAll('#newClassScheduleDays input[type="checkbox"]');

            // Clear all editable fields first
            if (newClassTeacher) newClassTeacher.value = 'Không thay đổi';
            if (newClassTeachingAssistant) newClassTeachingAssistant.value = 'Không thay đổi';
            if (newClassRoom) newClassRoom.value = '';
            if (newClassStartDate) newClassStartDate.value = '';
            if (newClassEndDate) newClassEndDate.value = '';
            if (newClassStatus) newClassStatus.value = 'Không thay đổi';
            if (newClassMaxStudents) newClassMaxStudents.value = '';
            if (newClassScheduleTimeStart) newClassScheduleTimeStart.value = '';
            if (newClassScheduleTimeEnd) newClassScheduleTimeEnd.value = '';
            scheduleDaysCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            if (selectedClass) {
                // Populate fields with data from the selected class
                if (newClassTeacher) newClassTeacher.value = selectedClass.teacher || 'Không thay đổi';
                if (newClassTeachingAssistant) newClassTeachingAssistant.value = selectedClass.teachingAssistant || 'Không thay đổi';
                if (newClassRoom) newClassRoom.value = selectedClass.room || '';
                if (newClassStartDate) newClassStartDate.value = selectedClass.startDate || '';
                if (newClassEndDate) newClassEndDate.value = selectedClass.endDate || '';
                if (newClassStatus) newClassStatus.value = selectedClass.status || 'Không thay đổi';
                if (newClassMaxStudents) newClassMaxStudents.value = selectedClass.maxStudents || '';
                if (newClassScheduleTimeStart) newClassScheduleTimeStart.value = selectedClass.scheduleTimeStart || '';
                if (newClassScheduleTimeEnd) newClassScheduleTimeEnd.value = selectedClass.scheduleTimeEnd || '';
                
                // Populate checkboxes for schedule days
                scheduleDaysCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectedClass.scheduleDays.includes(checkbox.value);
                });
            }
        }

        /**
         * Xử lý việc chọn một nhân sự để chỉnh sửa và điền dữ liệu vào các trường.
         * Handles selecting a staff member for editing and populating the fields.
         */
        function handleStaffToEditSelection() {
            const staffToEditSelect = document.getElementById('staffToEditId');
            const selectedStaffId = staffToEditSelect.value.split(' - ')[0];

            const selectedStaff = mockExistingStaff.find(staff => staff.id === selectedStaffId);

            // Get all editable fields for staff edit
            const newStaffBranch = document.getElementById('newStaffBranch');
            const newStaffDepartment = document.getElementById('newStaffDepartment');
            const newStaffPosition = document.getElementById('newStaffPosition');
            const newStaffPhone = document.getElementById('newStaffPhone');
            const newStaffEmail = document.getElementById('newStaffEmail');
            const newStaffAddress = document.getElementById('newStaffAddress');
            const newStaffContractType = document.getElementById('newStaffContractType');
            const newStaffBankAccount = document.getElementById('newStaffBankAccount');
            const newStaffBankBranch = document.getElementById('newStaffBankBranch');
            const newStaffCertificates = document.getElementById('newStaffCertificates');
            const certificateFilesInput = document.getElementById('newStaffCertificateFiles');
            const fileListDisplay = document.getElementById('newStaffCertificateFilesDisplay');

            // Clear all editable fields first
            if (newStaffBranch) newStaffBranch.value = 'Không thay đổi';
            if (newStaffDepartment) newStaffDepartment.value = 'Không thay đổi';
            if (newStaffPosition) newStaffPosition.value = 'Không thay đổi';
            if (newStaffPhone) newStaffPhone.value = '';
            if (newStaffEmail) newStaffEmail.value = '';
            if (newStaffAddress) newStaffAddress.value = '';
            if (newStaffContractType) newStaffContractType.value = 'Không thay đổi';
            if (newStaffBankAccount) newStaffBankAccount.value = '';
            if (newStaffBankBranch) newStaffBankBranch.value = '';
            if (newStaffCertificates) newStaffCertificates.value = '';
            if (certificateFilesInput) certificateFilesInput.value = '';
            if (fileListDisplay) fileListDisplay.textContent = 'Chưa có tệp nào được chọn.';


            if (selectedStaff) {
                // Helper to set select value, ensuring it matches an existing option or defaults
                const setSelectValue = (element, valueToSet, defaultValue = 'Không thay đổi') => {
                    if (element) {
                        let found = false;
                        for (let i = 0; i < element.options.length; i++) {
                            if (element.options[i].value === valueToSet) {
                                element.value = valueToSet;
                                found = true;
                                break;
                            }
                        }
                        if (!found) {
                            element.value = defaultValue;
                        }
                    }
                };

                // Populate fields with data from the selected staff
                setSelectValue(newStaffBranch, selectedStaff.branch);
                setSelectValue(newStaffDepartment, selectedStaff.department);
                setSelectValue(newStaffPosition, selectedStaff.position);
                setSelectValue(newStaffContractType, selectedStaff.contractType);

                if (newStaffPhone) newStaffPhone.value = selectedStaff.phone || '';
                if (newStaffEmail) newStaffEmail.value = selectedStaff.email || '';
                if (newStaffAddress) newStaffAddress.value = selectedStaff.address || '';
                if (newStaffBankAccount) newStaffBankAccount.value = selectedStaff.bankAccount || '';
                if (newStaffBankBranch) newStaffBankBranch.value = selectedStaff.bankBranch || '';
                if (newStaffCertificates) newStaffCertificates.value = selectedStaff.certificates || '';
            }
        }

        /**
         * Handles the selection of a student for editing and populates the fields.
         */
        function handleStudentToEditSelection() {
            const studentToEditSelect = document.getElementById('studentToEditId');
            const selectedStudentId = studentToEditSelect.value.split(' - ')[0];

            const selectedStudent = mockExistingStudents.find(student => student.id === selectedStudentId);

            // Get all editable fields for student edit
            const newStudentPhone = document.getElementById('newStudentPhone');
            const newStudentEmail = document.getElementById('newStudentEmail');
            const newStudentAddress = document.getElementById('newStudentAddress');
            const newStudentBranch = document.getElementById('newStudentBranch');
            const newStudentConsultant = document.getElementById('newStudentConsultant');
            const newStudentClass = document.getElementById('newStudentClass');
            const newStudentEntryLevel = document.getElementById('newStudentEntryLevel');
            const newStudentStatus = document.getElementById('newStudentStatus');

            // Clear all editable fields first
            if (newStudentPhone) newStudentPhone.value = '';
            if (newStudentEmail) newStudentEmail.value = '';
            if (newStudentAddress) newStudentAddress.value = '';
            if (newStudentBranch) newStudentBranch.value = 'Không thay đổi';
            if (newStudentConsultant) {
                newStudentConsultant.value = '';
                delete newStudentConsultant.dataset.accountName;
                newStudentConsultant.readOnly = false;
                newStudentConsultant.classList.remove('read-only-field');
            }
            if (newStudentClass) newStudentClass.value = 'Không thay đổi';
            if (newStudentEntryLevel) newStudentEntryLevel.value = '';
            if (newStudentStatus) newStudentStatus.value = 'Không thay đổi';


            if (selectedStudent) {
                // Helper to set select value, ensuring it matches an existing option or defaults
                const setSelectValue = (element, valueToSet, defaultValue = 'Không thay đổi') => {
                    if (element) {
                        let found = false;
                        for (let i = 0; i < element.options.length; i++) {
                            if (element.options[i].value === valueToSet) {
                                element.value = valueToSet;
                                found = true;
                                break;
                            }
                        }
                        if (!found) {
                            element.value = defaultValue;
                        }
                    }
                };

                // Populate fields with data from the selected student
                if (newStudentPhone) newStudentPhone.value = selectedStudent.phone || '';
                if (newStudentEmail) newStudentEmail.value = selectedStudent.email || '';
                if (newStudentAddress) newStudentAddress.value = selectedStudent.address || '';
                if (newStudentEntryLevel) newStudentEntryLevel.value = selectedStudent.entryLevel || '';

                setSelectValue(newStudentBranch, selectedStudent.branch);
                setSelectValue(newStudentClass, selectedStudent.class);
                setSelectValue(newStudentStatus, selectedStudent.status);

                // Special handling for consultant field
                if (newStudentConsultant) {
                    const foundConsultant = mockConsultantAccounts.find(c => c.displayName === selectedStudent.consultant);
                    if (foundConsultant) {
                        newStudentConsultant.value = foundConsultant.displayName;
                        newStudentConsultant.dataset.accountName = foundConsultant.account;
                        newStudentConsultant.readOnly = true;
                        newStudentConsultant.classList.add('read-only-field');
                    } else {
                        newStudentConsultant.value = selectedStudent.consultant || '';
                        delete newStudentConsultant.dataset.accountName;
                        newStudentConsultant.readOnly = false;
                        newStudentConsultant.classList.remove('read-only-field');
                    }
                }
            }
        }

        /**
         * Handles the selection of a major for editing and populates the fields.
         */
        function handleMajorToEditSelection() {
            const majorToEditSelect = document.getElementById('majorToEdit');
            const selectedMajorName = majorToEditSelect.value;

            const selectedMajor = mockExistingMajors.find(major => major.name === selectedMajorName);

            // Get all editable fields for major edit
            const newMajorNameInput = document.getElementById('newMajorName');
            const newMajorNumLessonsInput = document.getElementById('newMajorNumLessons');
            const newMajorTuitionFeeInput = document.getElementById('newMajorTuitionFee');

            // Clear all editable fields first
            if (newMajorNameInput) newMajorNameInput.value = '';
            if (newMajorNumLessonsInput) newMajorNumLessonsInput.value = '';
            if (newMajorTuitionFeeInput) newMajorTuitionFeeInput.value = '';

            if (selectedMajor) {
                // Populate fields with data from the selected major
                // newMajorName is for changing the name, not displaying the current one.
                if (newMajorNumLessonsInput) newMajorNumLessonsInput.value = selectedMajor.numLessons || '';
                if (newMajorTuitionFeeInput) newMajorTuitionFeeInput.value = formatCurrency(selectedMajor.tuitionFee) || '';
            }
        }

        /**
         * Handles the selection of a purchase order for editing and populates the fields.
         */
        function handlePurchaseOrderToEditSelection() {
            const purchaseOrderToEditSelect = document.getElementById('purchaseOrderToEditId');
            const selectedPoId = purchaseOrderToEditSelect.value.split(' - ')[0];

            const selectedPO = mockExistingPurchaseOrders.find(po => po.id === selectedPoId);

            // Get all editable fields for purchase order edit
            const newPurchaseOrderItem = document.getElementById('newPurchaseOrderItem');
            const newPurchaseOrderQuantity = document.getElementById('newPurchaseOrderQuantity');
            const newPurchaseOrderUnitPrice = document.getElementById('newPurchaseOrderUnitPrice');
            const newPurchaseOrderStatus = document.getElementById('newPurchaseOrderStatus');
            const newPurchaseOrderExpectedDeliveryDate = document.getElementById('newPurchaseOrderExpectedDeliveryDate');
            const newPurchaseOrderSupplier = document.getElementById('newPurchaseOrderSupplier');

            // Clear all editable fields first
            if (newPurchaseOrderItem) newPurchaseOrderItem.value = '';
            if (newPurchaseOrderQuantity) newPurchaseOrderQuantity.value = '';
            if (newPurchaseOrderUnitPrice) newPurchaseOrderUnitPrice.value = '';
            if (newPurchaseOrderStatus) newPurchaseOrderStatus.value = 'Không thay đổi';
            if (newPurchaseOrderExpectedDeliveryDate) newPurchaseOrderExpectedDeliveryDate.value = '';
            if (newPurchaseOrderSupplier) newPurchaseOrderSupplier.value = '';

            if (selectedPO) {
                // Helper to set select value, ensuring it matches an existing option or defaults
                const setSelectValue = (element, valueToSet, defaultValue = 'Không thay đổi') => {
                    if (element) {
                        let found = false;
                        for (let i = 0; i < element.options.length; i++) {
                            if (element.options[i].value === valueToSet) {
                                element.value = valueToSet;
                                found = true;
                                break;
                            }
                        }
                        if (!found) {
                            element.value = defaultValue;
                        }
                    }
                };

                // Populate fields with data from the selected purchase order
                if (newPurchaseOrderItem) newPurchaseOrderItem.value = selectedPO.item || '';
                if (newPurchaseOrderQuantity) newPurchaseOrderQuantity.value = selectedPO.quantity || '';
                if (newPurchaseOrderUnitPrice) newPurchaseOrderUnitPrice.value = formatCurrency(selectedPO.unitPrice) || '';
                if (newPurchaseOrderExpectedDeliveryDate) newPurchaseOrderExpectedDeliveryDate.value = selectedPO.expectedDeliveryDate || '';
                if (newPurchaseOrderSupplier) newPurchaseOrderSupplier.value = selectedPO.supplier || '';
                setSelectValue(newPurchaseOrderStatus, selectedPO.status);
            }
        }

        /**
         * Handles the selection of a tuition record for editing and populates the fields.
         */
        function handleTuitionRecordToEditSelection() {
            const tuitionRecordToEditSelect = document.getElementById('tuitionRecordToEditId');
            const selectedTuitionId = parseInt(tuitionRecordToEditSelect.value.split(' - ')[0].replace('Mã: ', '')); // Extract ID from the displayed string

            const selectedTuition = allTuitionData.find(t => t.id === selectedTuitionId);

            // Get all relevant fields for tuition record edit
            const tuitionInitialTuitionDisplay = document.getElementById('tuitionInitialTuitionDisplay');
            const tuitionPaidAmountDisplay = document.getElementById('tuitionPaidAmountDisplay');
            const tuitionOldRemainingTuitionDisplay = document.getElementById('tuitionOldRemainingTuitionDisplay');
            const tuitionPaymentAmountInput = document.getElementById('tuitionPaymentAmount');
            const tuitionPaymentMethodUpdate = document.getElementById('tuitionPaymentMethodUpdate');
            const tuitionNewRemainingTuitionDisplay = document.getElementById('tuitionNewRemainingTuitionDisplay');
            const tuitionPaymentStatusUpdate = document.getElementById('tuitionPaymentStatusUpdate');
            const tuitionInvoiceImageUploadUpdate = document.getElementById('tuitionInvoiceImageUploadUpdate');
            const tuitionInvoiceImagePreviewUpdate = document.getElementById('tuitionInvoiceImagePreviewUpdate');
            const tuitionInvoiceImagePreviewUpdateContainer = document.getElementById('tuitionInvoiceImagePreviewUpdateContainer');
            const tuitionInvoiceImageUploadUpdateClearInvoiceImageBtn = document.getElementById('tuitionInvoiceImageUploadUpdateClearInvoiceImageBtn');


            // Clear previous values
            clearTuitionEditFields();

            if (selectedTuition) {
                const student = allStudents.find(s => s.id === selectedTuition.studentId);
                const initialTuition = selectedTuition.initialTuition - selectedTuition.discountValue; // This is the final tuition after discount, which is the "initial" for payment purposes
                const paidAmount = selectedTuition.paidAmount;
                const oldRemaining = initialTuition - paidAmount;

                // Populate fields with data from the selected tuition record
                if (tuitionInitialTuitionDisplay) tuitionInitialTuitionDisplay.value = formatCurrency(initialTuition);
                if (tuitionPaidAmountDisplay) tuitionPaidAmountDisplay.value = formatCurrency(paidAmount);
                if (tuitionOldRemainingTuitionDisplay) tuitionOldRemainingTuitionDisplay.value = formatCurrency(oldRemaining);

                // Initialize payment amount to 0 or remaining if it's unpaid
                if (tuitionPaymentAmountInput) {
                    if (selectedTuition.paymentStatus === 'unpaid' || selectedTuition.paymentStatus === 'partially_paid') {
                        tuitionPaymentAmountInput.value = formatCurrency(oldRemaining); // Suggest paying the full remaining amount
                    } else {
                        tuitionPaymentAmountInput.value = '0';
                    }
                    // Trigger calculation for new remaining tuition immediately
                    tuitionPaymentAmountInput.dispatchEvent(new Event('input'));
                }

                if (tuitionPaymentMethodUpdate) {
                    tuitionPaymentMethodUpdate.value = allPaymentMethods.find(pm => pm.value === selectedTuition.paymentMethod)?.text || '';
                }
                if (tuitionPaymentStatusUpdate) {
                    tuitionPaymentStatusUpdate.value = allPaymentStatuses.find(ps => ps.value === selectedTuition.paymentStatus)?.text || '';
                }

                if (selectedTuition.invoiceImage) {
                    currentInvoiceBase64 = selectedTuition.invoiceImage;
                    if (tuitionInvoiceImagePreviewUpdate) tuitionInvoiceImagePreviewUpdate.src = currentInvoiceBase64;
                    if (tuitionInvoiceImagePreviewUpdateContainer) tuitionInvoiceImagePreviewUpdateContainer.style.display = 'flex';
                    if (tuitionInvoiceImageUploadUpdateClearInvoiceImageBtn) tuitionInvoiceImageUploadUpdateClearInvoiceImageBtn.style.display = 'block';
                } else {
                    currentInvoiceBase64 = '';
                    if (tuitionInvoiceImagePreviewUpdate) tuitionInvoiceImagePreviewUpdate.src = '';
                    if (tuitionInvoiceImagePreviewUpdateContainer) tuitionInvoiceImagePreviewUpdateContainer.style.display = 'none';
                    if (tuitionInvoiceImageUploadUpdateClearInvoiceImageBtn) tuitionInvoiceImageUploadUpdateClearInvoiceImageBtn.style.display = 'none';
                }
            }
        }


        // Lắng nghe sự kiện gửi biểu mẫu chính
        // Listens for the main form submission event.
        requestForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const requestType = requestTypeSelect.value;
            const requestDescription = document.getElementById('requestDescription').value;
            const selectedAppraiserId = appraiserSelect.value;
            const selectedAppraiserName = appraiserSelect.options[appraiserSelect.selectedIndex].text;
            const selectedApproverId = approverSelect.value;
            const selectedApproverName = approverSelect.options[approverSelect.selectedIndex].text;

            if (!requestType) {
                showCustomMessage('Vui lòng chọn loại yêu cầu.');
                return;
            }
            // Validate requestDescription only if it's visible and required
            if (requestDescriptionGroup && requestDescriptionGroup.style.display !== 'none' && requestDescriptionInput && requestDescriptionInput.required && requestDescription.trim() === '') {
                showCustomMessage('Vui lòng nhập mô tả chi tiết yêu cầu.');
                return;
            }
            if (!selectedApproverId) {
                showCustomMessage('Vui lòng chọn người phê duyệt.');
                return;
            }

            let appraiserData = null;
            // Only set appraiser data if it's not an 'edit_tuition_record_request' or 'leave_request'
            if (requestType !== 'edit_tuition_record_request' && requestType !== 'leave_request' && selectedAppraiserId) {
                appraiserData = {
                    id: selectedAppraiserId,
                    name: selectedAppraiserName
                };
            }

            let initialRequestStatus;
            let confirmationMessage;

            if (requestType === 'edit_tuition_record_request' || requestType === 'leave_request' || !appraiserData) {
                initialRequestStatus = 'Đang chờ phê duyệt';
                confirmationMessage = 'Bạn có chắc chắn muốn gửi yêu cầu này? Yêu cầu sẽ được chuyển trực tiếp đến người phê duyệt.';
            } else {
                initialRequestStatus = 'Đang chờ thẩm định';
                confirmationMessage = 'Bạn có chắc chắn muốn gửi yêu cầu này? Yêu cầu sẽ qua thẩm định trước khi chuyển sang phê duyệt.';
            }

            const requestData = {
                requesterName: requesterNameInput.value,
                requesterRole: requesterRoleInput.value,
                requestType: requestType,
                description: requestDescription,
                appraiser: appraiserData,
                approver: {
                    id: selectedApproverId,
                    name: selectedApproverName
                },
                status: initialRequestStatus,
                submissionDate: new Date().toISOString().split('T')[0]
            };

            const fields = requestFields[requestType];
            if (fields) {
                let allDynamicFieldsFilled = true;
                let changesMade = false;

                for (const field of fields) {
                    const input = document.getElementById(field.id);

                    // Skip the student filter field as it's not part of the data to be submitted
                    if (field.id === 'studentFilterForTuitionEdit') {
                        continue;
                    }

                    // Handle optional fields and required fields (considering dynamic 'required' attribute)
                    if (!input) {
                        // For display-only fields that might not exist in the DOM (like tuitionStudentNameDisplay)
                        // or if they are optional and not present, just skip.
                        if (!field.optional && !field.readOnly && field.id !== 'tuitionStudentNameDisplay' && !field.visible === false) { // Added field.visible check
                            allDynamicFieldsFilled = false;
                            showCustomMessage(`Lỗi: Trường '${field.label}' không tìm thấy hoặc không được điền.`);
                            return;
                        }
                        continue; // Skip if optional/readOnly and element not found
                    }

                    // Check if the input is disabled and if it's required (disabled fields are not validated)
                    if (input.disabled && input.required) {
                        continue;
                    }

                    if (input.required && input.value.trim() === '') {
                        if (input.type === 'file' && (field.id === 'tuitionInvoiceImageUpload' || field.id === 'tuitionInvoiceImageUploadUpdate')) {
                            if (!currentInvoiceBase64) { // Special check for invoice file input if it's required and no base64 image
                                allDynamicFieldsFilled = false;
                                showCustomMessage(`Vui lòng tải lên tệp cho trường '${field.label}'.`);
                                return;
                            }
                        } else if (input.type === 'file' && input.files.length === 0) { // General file input required check
                            allDynamicFieldsFilled = false;
                            showCustomMessage(`Vui lòng tải lên tệp cho trường '${field.label}'.`);
                            return;
                        } else if (input.type !== 'file') { // General check for other input types
                            allDynamicFieldsFilled = false;
                            showCustomMessage(`Vui lòng điền đầy đủ trường '${field.label}'.`);
                            return;
                        }
                    }


                    if (field.id === 'appraiserSelect') {
                        continue;
                    }

                    if ((field.id === 'studentConsultant' && type === 'student_request') || (field.id === 'newStudentConsultant' && type === 'edit_student_info_request')) {
                        const accountName = input.dataset.accountName;
                        if (!accountName) {
                            allDynamicFieldsFilled = false;
                            showCustomMessage('Vui lòng nhập tên tài khoản nhân viên tư vấn hợp lệ.');
                            return;
                        }
                        requestData[field.id] = accountName;
                        changesMade = true;
                    } else if (field.type === 'file') {
                        if (field.id === 'tuitionInvoiceImageUpload' || field.id === 'tuitionInvoiceImageUploadUpdate') {
                            // This is the specific invoice image field, use its dedicated base64
                            if (currentInvoiceBase64) {
                                requestData[field.id] = {
                                    name: input.files[0] ? input.files[0].name : 'uploaded_invoice_image',
                                    size: input.files[0] ? input.files[0].size : 0,
                                    type: input.files[0] ? input.files[0].type : 'image/png',
                                    base64: currentInvoiceBase64
                                };
                                changesMade = true;
                            } else {
                                requestData[field.id] = null;
                            }
                        } else {
                            // This is a generic file upload field (e.g., supportingDocuments for leave request)
                            if (input.files && input.files.length > 0) {
                                const fileData = [];
                                for (let i = 0; i < input.files.length; i++) {
                                    const file = input.files[i];
                                    // For a real application, you'd convert to base64 or upload to storage
                                    // For this mock, we'll just store basic info
                                    fileData.push({
                                        name: file.name,
                                        size: file.size,
                                        type: file.type
                                    });
                                }
                                requestData[field.id] = fileData;
                                changesMade = true;
                            } else {
                                requestData[field.id] = null;
                            }
                        }
                    } else if (field.type === 'checkbox-group') {
                        const checkboxes = document.querySelectorAll(`#${field.id} input[type="checkbox"]:checked`);
                        const selectedValues = Array.from(checkboxes).map(cb => cb.value);
                        requestData[field.id] = selectedValues;

                        if (!field.optional && selectedValues.length === 0) {
                            allDynamicFieldsFilled = false;
                            showCustomMessage(`Vui lòng chọn ít nhất một tùy chọn cho '${field.label}'.`);
                            return;
                        }
                        if (requestType === 'edit_class_request' && field.id === 'newClassScheduleDays') {
                            const classToEditSelect = document.getElementById('classToEditId');
                            const selectedClassId = classToEditSelect.value.split(' - ')[0];
                            const originalClass = mockExistingClasses.find(cls => cls.id === selectedClassId);
                            if (originalClass && JSON.stringify(selectedValues.sort()) !== JSON.stringify(originalClass.scheduleDays.sort())) {
                                changesMade = true;
                            }
                        } else {
                            if (selectedValues.length > 0) changesMade = true;
                        }

                    } else if (field.type === 'radio-group') {
                        const selectedRadio = document.querySelector(`input[name="${field.id}"]:checked`);
                        if (!selectedRadio && !field.optional) {
                            allDynamicFieldsFilled = false;
                            showCustomMessage(`Vui lòng chọn một tùy chọn cho '${field.label}'.`);
                            return;
                        }
                        if (selectedRadio) {
                            requestData[field.id] = selectedRadio.value;
                            changesMade = true;
                        }
                    }
                    else if (field.type === 'document_selector') {
                        const selectedDocIdInput = document.getElementById(`${field.id}Id`);
                        const selectedId = selectedDocIdInput.value;

                        if (!selectedId) {
                            allDynamicFieldsFilled = false;
                            showCustomMessage(`Vui lòng chọn một tài liệu hợp lệ cho '${field.label}'.`);
                            return;
                        }
                        const selectedDoc = mockExistingDocuments.find(doc => doc.id === selectedId);
                        if (selectedDoc) {
                            requestData[field.id] = {
                                id: selectedDoc.id,
                                name: selectedDoc.name,
                                type: selectedDoc.type,
                                path: selectedDoc.path
                            };
                            changesMade = true;
                        } else {
                            allDynamicFieldsFilled = false;
                            showCustomMessage(`Tài liệu đã chọn không hợp lệ cho '${field.label}'.`);
                            return;
                        }
                    }
                    else {
                        let valueToStore = input.value;
                        if (field.format === 'currency' || field.format === 'currency-or-percentage') {
                            valueToStore = unformatCurrency(input.value);
                        }
                        if (field.format === 'currency-or-percentage' && requestType.includes('tuition')) {
                            const discountTypeRadio = document.querySelector(`input[name="${field.id.replace('Value', 'Type')}"]:checked`);
                            if (discountTypeRadio && discountTypeRadio.value === 'percentage') {
                                valueToStore = parseFloat(String(input.value).replace('%', ''));
                            }
                        }

                        const originalDataLookup = {
                            'edit_class_request': { data: mockExistingClasses, idField: 'classToEditId' },
                            'change_staff_info_request': { data: mockExistingStaff, idField: 'staffToEditId' },
                            'edit_student_info_request': { data: mockExistingStudents, idField: 'studentToEditId' },
                            'edit_major_request': { data: mockExistingMajors, idField: 'majorToEdit' },
                            'edit_purchase_order_request': { data: mockExistingPurchaseOrders, idField: 'purchaseOrderToEditId' },
                            'edit_tuition_record_request': { data: allTuitionData, idField: 'tuitionRecordToEditId' }
                        };

                        if (originalDataLookup[requestType]) {
                            const { data, idField } = originalDataLookup[requestType];
                            const selectedItemIdRaw = document.getElementById(idField).value;
                            let selectedItemId;
                            if (idField === 'tuitionRecordToEditId') {
                                selectedItemId = parseInt(selectedItemIdRaw.split(' - ')[0].replace('Mã: ', '')); // Extract ID from the displayed string
                            } else if (idField === 'majorToEdit') {
                                selectedItemId = selectedItemIdRaw; // For major, the value is the name
                            } else {
                                selectedItemId = selectedItemIdRaw.split(' - ')[0];
                            }

                            const originalItem = data.find(item => {
                                if (idField === 'majorToEdit') return item.name === selectedItemId;
                                return String(item.id) === String(selectedItemId);
                            });

                            let originalFieldKey = field.id.replace(/^(newTuition|newClass|newStaff|newStudent|newMajor|newPurchaseOrder|tuition)/, '').toLowerCase();
                            // Special handling for tuition fields to map to original data keys
                            if (originalFieldKey === 'initialtuitiondisplay') originalFieldKey = 'initialTuition';
                            if (originalFieldKey === 'paidamountdisplay') originalFieldKey = 'paidAmount';
                            if (originalFieldKey === 'oldremainingtuitiondisplay') originalFieldKey = 'finalTuition'; // This is the final tuition after discount, before any payments
                            if (originalFieldKey === 'paymentamount') originalFieldKey = 'paymentAmount'; // This is a new input, no direct original field
                            if (originalFieldKey === 'paymentmethodupdate') originalFieldKey = 'paymentMethod';
                            if (originalFieldKey === 'newremainingtuitiondisplay') originalFieldKey = 'finalTuition'; // This is the calculated new remaining
                            if (originalFieldKey === 'paymentstatusupdate') originalFieldKey = 'paymentStatus';
                            if (originalFieldKey === 'invoiceimageuploadupdate') originalFieldKey = 'invoiceImage';

                            if (originalItem) {
                                let originalValue = originalItem[originalFieldKey];
                                if (field.format === 'currency' && typeof originalValue === 'number') {
                                    originalValue = unformatCurrency(originalValue);
                                }
                                if (field.type === 'select' && input.value === 'Không thay đổi') {
                                    // Do nothing, means no change
                                } else if (String(valueToStore) !== String(originalValue)) {
                                    requestData[field.id] = valueToStore;
                                    changesMade = true;
                                }
                            } else {
                                requestData[field.id] = valueToStore;
                                if (String(valueToStore).trim() !== '') changesMade = true;
                            }
                        } else {
                            requestData[field.id] = valueToStore;
                            if (String(valueToStore).trim() !== '') changesMade = true;
                        }
                    }
                }

                if (!allDynamicFieldsFilled) {
                    return;
                }

                if (requestType.startsWith('edit_') && !changesMade) {
                    showCustomMessage('Vui lòng thực hiện ít nhất một thay đổi để gửi yêu cầu chỉnh sửa.');
                    return;
                }

                // Handle specific request types for data manipulation
                if (requestType === 'create_tuition_record_request') {
                    const studentName = document.getElementById('tuitionStudentId').value;
                    const majorName = document.getElementById('tuitionMajorId').value;
                    const initialTuition = unformatCurrency(document.getElementById('tuitionInitialTuition').value);
                    const discountTypeRadio = document.querySelector('input[name="tuitionDiscountType"]:checked');
                    const discountType = discountTypeRadio ? discountTypeRadio.value : 'amount'; // Default to 'amount'
                    let discountValue = unformatCurrency(document.getElementById('tuitionDiscountValue').value);
                    if (discountType === 'percentage') {
                        discountValue = parseFloat(document.getElementById('tuitionDiscountValue').value.replace('%', ''));
                    }
                    const finalTuition = unformatCurrency(document.getElementById('tuitionFinalTuition').value);
                    const paymentDate = document.getElementById('tuitionPaymentDate').value;
                    const paymentMethodText = document.getElementById('tuitionPaymentMethod').value;
                    const paymentStatusText = document.getElementById('tuitionPaymentStatus').value;
                    const completionStatusText = document.getElementById('tuitionCompletionStatus').value;
                    const completionAppointmentDate = document.getElementById('tuitionCompletionAppointmentDate').value;

                    const newTuitionRecord = {
                        id: Date.now(), // Simple unique ID
                        studentId: mockTuitionStudents.find(s => s.name === studentName)?.id,
                        majorId: mockTuitionMajors.find(m => m.name === majorName)?.id,
                        initialTuition: initialTuition,
                        discountType: discountType,
                        discountValue: discountValue,
                        finalTuition: finalTuition,
                        paidAmount: 0, // New records start with 0 paid
                        paymentDate: paymentDate,
                        paymentMethod: mockTuitionPaymentMethods.find(pm => pm.text === paymentMethodText)?.value,
                        paymentStatus: mockTuitionPaymentStatuses.find(ps => ps.text === paymentStatusText)?.value,
                        invoiceImage: currentInvoiceBase64,
                        completionStatus: mockTuitionCompletionStatuses.find(cs => cs.text === completionStatusText)?.value,
                        completionAppointmentDate: completionAppointmentDate
                    };
                    allTuitionData.push(newTuitionRecord);
                    confirmationMessage = 'Yêu cầu thêm học phí mới đã được gửi thành công!';

                } else if (requestType === 'edit_tuition_record_request') {
                    const tuitionIdToEdit = parseInt(document.getElementById('tuitionRecordToEditId').value.split(' - ')[0].replace('Mã: ', ''));
                    const index = allTuitionData.findIndex(t => t.id === tuitionIdToEdit);

                    if (index !== -1) {
                        const existingTuition = allTuitionData[index];

                        const paymentAmount = unformatCurrency(document.getElementById('tuitionPaymentAmount').value);
                        const newPaidAmount = existingTuition.paidAmount + paymentAmount;
                        const newRemainingTuition = unformatCurrency(document.getElementById('tuitionNewRemainingTuitionDisplay').value);
                        const paymentMethodText = document.getElementById('tuitionPaymentMethodUpdate').value;
                        const paymentStatusText = document.getElementById('tuitionPaymentStatusUpdate').value;

                        const updatedTuitionData = {
                            ...existingTuition, // Keep existing data
                            paidAmount: newPaidAmount,
                            paymentMethod: mockTuitionPaymentMethods.find(pm => pm.text === paymentMethodText)?.value || existingTuition.paymentMethod,
                            paymentStatus: mockTuitionPaymentStatuses.find(ps => ps.text === paymentStatusText)?.value || existingTuition.paymentStatus,
                            invoiceImage: currentInvoiceBase64 || existingTuition.invoiceImage,
                            // Update paymentDate only if status becomes 'paid' and it wasn't already set
                            paymentDate: (paymentStatusText === mockTuitionPaymentStatuses.find(ps => ps.value === 'paid')?.text && !existingTuition.paymentDate) ? new Date().toISOString().split('T')[0] : existingTuition.paymentDate,
                            // If remaining is 0, update finalTuition to reflect full payment
                            finalTuition: newRemainingTuition <= 0 ? (existingTuition.initialTuition - existingTuition.discountValue) : existingTuition.finalTuition // This ensures finalTuition is correct if fully paid
                        };

                        allTuitionData[index] = updatedTuitionData;
                        confirmationMessage = 'Yêu cầu chỉnh sửa học phí đã được gửi thành công!';
                    } else {
                        showCustomMessage('Không tìm thấy bản ghi học phí để chỉnh sửa.');
                        return;
                    }
                } else if (requestType === 'leave_request') {
                    const leaveType = document.getElementById('leaveType').value;
                    const leavePeriodType = document.querySelector('input[name="leavePeriodType"]:checked').value;
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    const startTime = document.getElementById('startTime').value;
                    const endTime = document.getElementById('endTime').value;
                    const reason = document.getElementById('reason').value;

                    // Basic validation for dates
                    if (new Date(startDate) > new Date(endDate)) {
                        showCustomMessage('Ngày bắt đầu không thể sau ngày kết thúc.');
                        return;
                    }

                    if (leavePeriodType === 'by_hour' && startDate !== endDate) {
                        showCustomMessage('Đối với nghỉ theo giờ, Ngày bắt đầu và Ngày kết thúc phải là cùng một ngày.');
                        return;
                    }

                    const newLeaveRequest = {
                        id: Date.now(),
                        leaveType: leaveType,
                        leavePeriodType: leavePeriodType,
                        startDate: startDate,
                        endDate: endDate,
                        startTime: leavePeriodType === 'by_hour' ? startTime : null,
                        endTime: leavePeriodType === 'by_hour' ? endTime : null,
                        reason: reason,
                        supportingDocuments: requestData.supportingDocuments // This will be handled by the file input logic
                    };
                    console.log('New Leave Request:', newLeaveRequest);
                    confirmationMessage = 'Yêu cầu xin nghỉ đã được gửi thành công!';
                }
            }

            showConfirmationBox(confirmationMessage, () => {
                showFullScreenLoading();
                console.log('Request Data Submitted:', requestData);
                setTimeout(() => {
                    hideFullScreenLoading();
                    showCustomMessage('Yêu cầu của bạn đã được gửi thành công! Chúng tôi sẽ xem xét và phản hồi sớm nhất.');
                    requestForm.reset();
                    dynamicFormFieldsDiv.innerHTML = '';
                    requestTypeSelect.value = '';
                    populateSelectWithApprovers(appraiserSelect, 'Chọn người thẩm định (tùy chọn)...');
                    populateSelectWithApprovers(approverSelect, 'Chọn người phê duyệt...');
                    updateRequestStatusDisplay();
                    currentInvoiceBase64 = ''; // Clear for next request
                }, 2000);
            });
        });

        // --- Document Selection Modal Logic ---
        const documentSelectionModal = document.getElementById('documentSelectionModal');
        const closeDocumentModalBtn = document.getElementById('closeDocumentModal');
        const documentSearchInput = document.getElementById('documentSearchInput');
        const documentTypeFilter = document.getElementById('documentTypeFilter');
        const documentListContainer = document.getElementById('documentListContainer');

        /**
         * Hiển thị modal chọn tài liệu.
         * Displays the document selection modal.
         */
        function showDocumentModal() {
            documentSelectionModal.classList.add('show');
            documentSearchInput.value = '';
            documentTypeFilter.value = '';
            renderDocumentList(mockExistingDocuments);
        }

        /**
         * Ẩn modal chọn tài liệu.
         * Hides the document selection modal.
         */
        function hideDocumentModal() {
            documentSelectionModal.classList.remove('show');
        }

        closeDocumentModalBtn.addEventListener('click', hideDocumentModal);
        documentSelectionModal.addEventListener('click', (event) => {
            if (event.target === documentSelectionModal) {
                hideDocumentModal();
            }
        });

        /**
         * Hiển thị danh sách tài liệu trong modal.
         * Displays the list of documents in the modal.
         * @param {Array<Object>} documents - Mảng các đối tượng tài liệu. Array of document objects.
         */
        function renderDocumentList(documents) {
            documentListContainer.innerHTML = '';

            if (documents.length === 0) {
                const noDocsMessage = document.createElement('div');
                noDocsMessage.classList.add('no-documents-found');
                noDocsMessage.textContent = 'Không tìm thấy tài liệu nào phù hợp.';
                documentListContainer.appendChild(noDocsMessage);
                return;
            }

            documents.forEach(doc => {
                const listItem = document.createElement('div');
                listItem.classList.add('document-list-item');
                listItem.dataset.docId = doc.id;
                listItem.dataset.docName = doc.name;
                listItem.dataset.docType = doc.type;
                listItem.dataset.docPath = doc.path;

                listItem.innerHTML = `
                    <div class="doc-info">
                        <span class="doc-name">${doc.name}</span>
                        <span class="doc-type">Loại: ${doc.type}</span>
                    </div>
                    <span class="doc-id">${doc.id}</span>
                `;
                documentListContainer.appendChild(listItem);

                listItem.addEventListener('click', () => {
                    const selectedDocId = listItem.dataset.docId;
                    const selectedDocName = listItem.dataset.docName;
                    const selectedDocPath = listItem.dataset.docPath;

                    document.getElementById('documentToAccess').value = selectedDocName;
                    document.getElementById('documentToAccessId').value = selectedDocId;
                    document.getElementById('documentPathDisplay').value = selectedDocPath;

                    hideDocumentModal();
                });
            });
        }

        // Logic lọc và tìm kiếm cho modal
        // Filtering and search logic for the modal.
        function filterDocuments() {
            const searchTerm = documentSearchInput.value.toLowerCase();
            const selectedType = documentTypeFilter.value;

            const filtered = mockExistingDocuments.filter(doc => {
                const matchesSearch = doc.name.toLowerCase().includes(searchTerm) || doc.id.toLowerCase().includes(searchTerm);
                const matchesType = selectedType === '' || doc.type === selectedType;
                return matchesSearch && matchesType;
            });
            renderDocumentList(filtered);
        }

        documentSearchInput.addEventListener('input', filterDocuments);
        documentTypeFilter.addEventListener('change', filterDocuments);


        // --- Tuition Management Data (from Tusision.html) ---
        // These variables are kept to support tuition-related requests within the request form.
        let allTuitionData = [];
        let allStudents = [];
        let allMajors = [];
        let allPaymentStatuses = [];
        let allCompletionStatuses = [];
        let allPaymentMethods = [];
        let currentInvoiceBase64 = '';

        // Initial setup
        document.addEventListener('DOMContentLoaded', function() {
            setLoggedInUserName("Người dùng Test");
            setLoggedInUserTitle("Vai trò Test");

            // Initialize Request Form section
            populateSelectWithApprovers(appraiserSelect, 'Chọn người thẩm định (tùy chọn)...');
            populateSelectWithApprovers(approverSelect, 'Chọn người phê duyệt...');
            updateRequestStatusDisplay(); // Call initially to set correct state for requestDescription

            // Initialize mock data for tuition management, as the request forms for tuition still rely on this data.
            allStudents = mockTuitionStudents;
            allMajors = mockTuitionMajors;
            allPaymentStatuses = mockTuitionPaymentStatuses;
            allCompletionStatuses = mockTuitionCompletionStatuses;
            allPaymentMethods = mockTuitionPaymentMethods;

            allTuitionData = [
                { id: 1, studentId: 101, majorId: 1, initialTuition: 2500000, discountType: 'amount', discountValue: 200000, finalTuition: 2300000, paidAmount: 0, paymentStatus: 'unpaid', paymentMethod: '', invoiceImage: '', completionStatus: 'in_progress', completionAppointmentDate: '2024-07-20', paymentDate: '' },
                { id: 2, studentId: 102, majorId: 2, initialTuition: 6000000, discountType: 'percentage', discountValue: 10, finalTuition: 5400000, paidAmount: 2000000, paymentStatus: 'partially_paid', paymentMethod: 'cash', invoiceImage: placeholderImageUrl, completionStatus: 'not_started', completionAppointmentDate: '2024-08-01', paymentDate: '2024-07-10' },
                { id: 3, studentId: 103, majorId: 3, initialTuition: 4000000, discountType: 'amount', discountValue: 500000, finalTuition: 3500000, paidAmount: 1000000, paymentStatus: 'partially_paid', paymentMethod: 'bank_transfer', invoiceImage: placeholderImageUrl, completionStatus: 'in_progress', completionAppointmentDate: '2024-07-18', paymentDate: '2024-07-05' },
                { id: 4, studentId: 101, majorId: 1, initialTuition: 2500000, discountType: 'amount', discountValue: 0, finalTuition: 2500000, paidAmount: 2500000, paymentStatus: 'paid', paymentMethod: 'bank_transfer', invoiceImage: placeholderImageUrl, completionStatus: 'completed', completionAppointmentDate: '2024-07-15', paymentDate: '2024-07-15' } // A fully paid record
            ];
        });
    </script>
</body>
</html>
